<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TruckEase - Premium Ride Sharing</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Leaflet for map (free) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: #f4f7fc; padding-bottom: 70px; }

        /* Header with glass effect */
        .header { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 15px; display: flex; align-items: center; gap: 10px; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .location-bar { background: #eef2ff; padding: 12px 18px; border-radius: 40px; flex: 1; font-size: 14px; color: #2854ff; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; box-shadow: 0 2px 8px rgba(40,84,255,0.1); transition: all 0.2s; }
        .location-bar:hover { background: #e0e7ff; transform: scale(1.02); }
        .lang-switch { background: white; border: 1px solid #e0e0e0; border-radius: 40px; padding: 10px 16px; font-weight: 600; cursor: pointer; font-size: 14px; color: #2854ff; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .user-icon { font-size: 24px; color: #2854ff; background: white; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(40,84,255,0.15); border: 1px solid rgba(40,84,255,0.1); }

        /* Tabs with underline effect */
        .tabs { display: flex; gap: 20px; padding: 15px 20px; overflow-x: auto; background: white; border-bottom: 1px solid #f0f0f0; }
        .tab { padding: 8px 0; font-weight: 600; font-size: 16px; color: #999; white-space: nowrap; cursor: pointer; border-bottom: 3px solid transparent; transition: 0.2s; }
        .tab.active { color: #2854ff; border-bottom-color: #2854ff; }

        /* Vehicle Cards - like Uber */
        .section-title { padding: 20px 20px 10px; font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .vehicle-grid { display: flex; flex-direction: column; gap: 12px; padding: 0 20px 20px; }
        .vehicle-card { background: white; border-radius: 24px; padding: 16px; display: flex; align-items: center; gap: 16px; box-shadow: 0 4px 16px rgba(0,0,0,0.02); border: 1px solid #f0f0f0; cursor: pointer; transition: 0.2s; }
        .vehicle-card:hover { border-color: #2854ff; box-shadow: 0 8px 24px rgba(40,84,255,0.1); transform: translateY(-2px); }
        .vehicle-card .icon { font-size: 48px; width: 60px; text-align: center; }
        .vehicle-info { flex: 1; }
        .vehicle-info h4 { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
        .vehicle-info p { font-size: 14px; color: #666; }
        .vehicle-price { text-align: right; }
        .vehicle-price .price { font-size: 20px; font-weight: 800; color: #2854ff; }
        .vehicle-price .eta { font-size: 13px; color: #10b981; margin-top: 4px; }

        /* Booking Screen */
        .screen { display: none; padding: 0; }
        .screen.active { display: block; }
        .booking-header { display: flex; align-items: center; gap: 20px; padding: 20px; background: white; border-bottom: 1px solid #f0f0f0; }
        .booking-header .back-btn { font-size: 24px; cursor: pointer; color: #2854ff; }
        .booking-header h3 { font-size: 20px; font-weight: 700; }
        .booking-content { padding: 20px; }

        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #444; }
        .input-group input { width: 100%; padding: 16px; border: 1px solid #e0e0e0; border-radius: 20px; font-size: 16px; transition: 0.2s; background: #fafafa; }
        .input-group input:focus { border-color: #2854ff; outline: none; background: white; box-shadow: 0 0 0 3px rgba(40,84,255,0.1); }

        .fare-box { background: linear-gradient(135deg, #eef2ff, #ffffff); padding: 20px; border-radius: 24px; text-align: center; margin: 20px 0; border: 1px solid rgba(40,84,255,0.2); }
        .fare-box .fare { font-size: 48px; font-weight: 800; color: #2854ff; line-height: 1.2; }
        .fare-box .breakdown { font-size: 14px; color: #666; margin-top: 8px; display: flex; justify-content: center; gap: 20px; }
        .btn { width: 100%; padding: 18px; border: none; border-radius: 30px; font-weight: 700; font-size: 18px; cursor: pointer; transition: 0.2s; margin-top: 10px; }
        .btn-primary { background: #2854ff; color: white; box-shadow: 0 10px 20px rgba(40,84,255,0.3); }
        .btn-primary:hover { background: #1a3ebb; transform: scale(1.02); }
        .btn-secondary { background: #e0e0e0; color: #333; }
        .btn-secondary:hover { background: #ccc; }

        #map { height: 240px; border-radius: 24px; margin: 20px 0; display: none; box-shadow: 0 8px 20px rgba(0,0,0,0.05); }

        /* History Items */
        .history-item { background: white; border-radius: 20px; padding: 16px; margin-bottom: 12px; border: 1px solid #f0f0f0; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .history-item .row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .status-badge { padding: 6px 14px; border-radius: 40px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-accepted { background: #cce5ff; color: #004085; }

        /* Login Modal - Premium */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 40px; width: 90%; max-width: 380px; text-align: center; box-shadow: 0 30px 60px rgba(0,0,0,0.3); }
        .modal-content h3 { font-size: 28px; font-weight: 800; margin-bottom: 20px; color: #2854ff; }
        .modal-content input { width: 100%; padding: 18px; margin: 10px 0; border: 1px solid #ddd; border-radius: 30px; font-size: 16px; }
        .demo-hint { background: #fef9e7; color: #b45f06; padding: 15px; border-radius: 20px; font-size: 14px; margin: 15px 0; border: 1px solid #f9e79f; }

        /* Bottom Navigation */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; max-width: 450px; background: white; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #eee; left: 50%; transform: translateX(-50%); z-index: 100; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); border-radius: 30px 30px 0 0; }
        .nav-item { text-align: center; color: #999; font-size: 12px; cursor: pointer; transition: 0.2s; }
        .nav-item.active { color: #2854ff; font-weight: 700; }
        .nav-item i { font-size: 24px; display: block; margin-bottom: 4px; }

        .loading { display: none; text-align: center; padding: 50px; }
        .loading.active { display: block; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #2854ff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<!-- Login Modal - Demo Mode -->
<div id="loginModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">üîê Demo Login</h3>
        <div class="demo-hint">
            <i class="fas fa-info-circle"></i> Enter any 10-digit number to continue
        </div>
        <div id="phoneSection">
            <input type="tel" id="phoneNumber" placeholder="e.g. 1234567890" maxlength="10" value="1234567890">
            <button class="btn btn-primary" id="demoLoginBtn" style="margin-top: 10px;">üöÄ Start Riding</button>
        </div>
        <p id="loginError" style="color:red; font-size:12px; margin-top:10px;"></p>
    </div>
</div>

<!-- Header -->
<div class="header">
    <div class="location-bar" id="currentLocText" onclick="getCurrentLocation()">
        <i class="fas fa-map-marker-alt"></i> <span id="locationPlaceholder">Set pickup location</span>
    </div>
    <button class="lang-switch" id="langToggle" onclick="toggleLanguage()">üá∫üá∏ EN</button>
    <div class="user-icon" id="userIcon" onclick="showLoginModal()">
        <i class="fas fa-user"></i>
    </div>
</div>

<!-- Home Screen -->
<div id="homeScreen" class="screen active">
    <div class="tabs" id="tabContainer">
        <div class="tab active" data-category="trucks" id="tabTrucks">üöö Trucks</div>
        <div class="tab" data-category="2wheeler" id="tab2Wheeler">üõµ 2 Wheeler</div>
        <div class="tab" data-category="packers" id="tabPackers">üì¶ Packers</div>
    </div>
    <h3 class="section-title" id="vehicleCategoryTitle"><i class="fas fa-truck"></i> Mini Trucks</h3>
    <div class="vehicle-grid" id="vehicleGrid"></div>
</div>

<!-- Booking Screen -->
<div id="bookingScreen" class="screen">
    <div class="booking-header">
        <i class="fas fa-arrow-left back-btn" onclick="goBack()"></i>
        <h3 id="bookingTitle">Confirm Your Ride</h3>
    </div>
    <div class="booking-content">
        <div id="selectedVehicleInfo" style="margin-bottom:20px; font-weight:600; font-size:18px;"></div>
        <div class="input-group">
            <label id="pickupLabel">üìç Pickup</label>
            <input type="text" id="pickupAddr" placeholder="Enter pickup address" value="Jalpura, Greater Noida">
        </div>
        <div class="input-group">
            <label id="dropLabel">üèÅ Drop</label>
            <input type="text" id="dropAddr" placeholder="Enter drop address">
        </div>
        <div class="input-group">
            <label id="distanceLabel">üìè Distance (miles) or use GPS</label>
            <input type="number" id="kmInput" placeholder="Distance in miles" oninput="calculateFare()">
        </div>
        <div id="map"></div>
        <button class="btn btn-secondary" onclick="getCurrentLocation()"><i class="fas fa-location-dot"></i> <span id="useLocationBtn">Use my current location</span></button>
        
        <!-- Fare Breakdown Box -->
        <div class="fare-box">
            <div class="fare" id="fareAmount">$0</div>
            <div class="breakdown">
                <span id="baseFare">Base: $0</span>
                <span id="distanceFare">Distance: $0</span>
                <span id="totalFare">Total: $0</span>
            </div>
        </div>

        <button class="btn btn-primary" onclick="confirmBooking()" id="confirmBtn">Confirm Ride</button>
    </div>
</div>

<!-- History Screen -->
<div id="historyScreen" class="screen">
    <div class="booking-header">
        <i class="fas fa-arrow-left back-btn" onclick="goBack()"></i>
        <h3 id="historyTitle">Your Trips</h3>
    </div>
    <div class="booking-content" id="historyList"></div>
</div>

<!-- Tracking Screen (Placeholder) -->
<div id="trackingScreen" class="screen">
    <div class="booking-header">
        <i class="fas fa-arrow-left back-btn" onclick="goBack()"></i>
        <h3 id="trackingTitle">Track Your Ride</h3>
    </div>
    <div class="booking-content">
        <div id="trackingMap" style="height:300px; border-radius:24px; margin-bottom:20px;"></div>
        <div id="trackingDetails" style="background:#f0f4ff; padding:20px; border-radius:20px; margin-bottom:20px;">
            <p><i class="fas fa-circle-notch fa-spin"></i> Driver is on the way...</p>
        </div>
        <button class="btn btn-secondary" onclick="cancelBooking()" id="cancelBtn">Cancel Ride</button>
    </div>
</div>

<!-- Success Screen -->
<div id="successScreen" class="screen">
    <div style="text-align:center; padding:50px 20px;">
        <i class="fas fa-check-circle" style="font-size:80px; color:#28a745;"></i>
        <h2 id="successTitle" style="margin:20px 0;">Ride Confirmed!</h2>
        <div id="successDetails" style="background:#e8f5e9; padding:25px; border-radius:30px; margin:20px;"></div>
        <button class="btn btn-primary" onclick="goHome()" id="backHomeBtn">Back to Home</button>
    </div>
</div>

<!-- Bottom Navigation -->
<div class="bottom-nav">
    <div class="nav-item active" onclick="showScreen('homeScreen')"><i class="fas fa-home"></i><span id="navHome">Home</span></div>
    <div class="nav-item" onclick="showScreen('historyScreen')"><i class="fas fa-history"></i><span id="navTrips">Trips</span></div>
    <div class="nav-item" onclick="alert('Coming soon')"><i class="fas fa-wallet"></i><span id="navPayment">Wallet</span></div>
    <div class="nav-item" onclick="alert('Coming soon')"><i class="fas fa-user"></i><span id="navProfile">Profile</span></div>
</div>

<!-- Loading -->
<div id="loading" class="loading"><div class="spinner"></div><p id="loadingText">Loading...</p></div>

<!-- Firebase SDK (only Firestore needed) -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // ---------- FIREBASE CONFIG ----------
    const firebaseConfig = {
        apiKey: "AIzaSyByh4tT4zcUpjjQ_ebaYzpSulGtsDHjbw0",
        authDomain: "truckease-cb961.firebaseapp.com",
        projectId: "truckease-cb961",
        storageBucket: "truckease-cb961.firebasestorage.app",
        messagingSenderId: "558046020925",
        appId: "1:558046020925:web:573533af4bbf93841e3154"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ---------- GLOBAL VARIABLES ----------
    let currentUser = null;
    let currentVehicle = null;
    let basePrice = 0, perKmRate = 0;
    let finalFare = 0;
    let map = null;
    let currentLanguage = 'en'; // 'en' or 'hi'

    // ---------- LANGUAGE DICTIONARY ----------
    const translations = {
        en: {
            modalTitle: "üîê Demo Login",
            phonePlaceholder: "e.g. 1234567890",
            locationPlaceholder: "Set pickup location",
            tabTrucks: "üöö Trucks",
            tab2Wheeler: "üõµ 2 Wheeler",
            tabPackers: "üì¶ Packers",
            vehicleCategoryTitle: "Mini Trucks",
            bookingTitle: "Confirm Your Ride",
            pickupLabel: "üìç Pickup",
            pickupPlaceholder: "Enter pickup address",
            dropLabel: "üèÅ Drop",
            dropPlaceholder: "Enter drop address",
            distanceLabel: "üìè Distance (miles) or use GPS",
            distancePlaceholder: "Distance in miles",
            useLocationBtn: "Use my current location",
            confirmBtn: "Confirm Ride",
            historyTitle: "Your Trips",
            trackingTitle: "Track Your Ride",
            cancelBtn: "Cancel Ride",
            successTitle: "Ride Confirmed!",
            backHomeBtn: "Back to Home",
            navHome: "Home",
            navTrips: "Trips",
            navPayment: "Wallet",
            navProfile: "Profile",
            loadingText: "Loading...",
            currencySymbol: "$",
            unit: "mi",
            eta: "mins away"
        },
        hi: {
            modalTitle: "üîê ‡§°‡•á‡§Æ‡•ã ‡§≤‡•â‡§ó‡§ø‡§®",
            phonePlaceholder: "‡§ú‡•à‡§∏‡•á 1234567890",
            locationPlaceholder: "‡§™‡§ø‡§ï‡§Ö‡§™ ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç",
            tabTrucks: "üöö ‡§ü‡•ç‡§∞‡§ï",
            tab2Wheeler: "üõµ ‡§¶‡•ã ‡§™‡§π‡§ø‡§Ø‡§æ",
            tabPackers: "üì¶ ‡§™‡•à‡§ï‡§∞‡•ç‡§∏",
            vehicleCategoryTitle: "‡§õ‡•ã‡§ü‡•á ‡§ü‡•ç‡§∞‡§ï",
            bookingTitle: "‡§Ö‡§™‡§®‡•Ä ‡§∞‡§æ‡§á‡§° ‡§ï‡§®‡•ç‡§´‡§∞‡•ç‡§Æ ‡§ï‡§∞‡•á‡§Ç",
            pickupLabel: "üìç ‡§™‡§ø‡§ï‡§Ö‡§™",
            pickupPlaceholder: "‡§™‡§ø‡§ï‡§Ö‡§™ ‡§™‡§§‡§æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç",
            dropLabel: "üèÅ ‡§°‡•ç‡§∞‡•â‡§™",
            dropPlaceholder: "‡§°‡•ç‡§∞‡•â‡§™ ‡§™‡§§‡§æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç",
            distanceLabel: "üìè ‡§¶‡•Ç‡§∞‡•Ä (‡§ï‡§ø‡§Æ‡•Ä) ‡§Ø‡§æ GPS ‡§á‡§∏‡•ç‡§§‡•á‡§Æ‡§æ‡§≤ ‡§ï‡§∞‡•á‡§Ç",
            distancePlaceholder: "‡§ï‡§ø‡§≤‡•ã‡§Æ‡•Ä‡§ü‡§∞ ‡§Æ‡•á‡§Ç ‡§¶‡•Ç‡§∞‡•Ä",
            useLocationBtn: "‡§Æ‡•á‡§∞‡•Ä ‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§á‡§∏‡•ç‡§§‡•á‡§Æ‡§æ‡§≤ ‡§ï‡§∞‡•á‡§Ç",
            confirmBtn: "‡§∞‡§æ‡§á‡§° ‡§ï‡§®‡•ç‡§´‡§∞‡•ç‡§Æ ‡§ï‡§∞‡•á‡§Ç",
            historyTitle: "‡§Ü‡§™‡§ï‡•Ä ‡§Ø‡§æ‡§§‡•ç‡§∞‡§æ‡§è‡§Å",
            trackingTitle: "‡§∞‡§æ‡§á‡§° ‡§ü‡•ç‡§∞‡•à‡§ï ‡§ï‡§∞‡•á‡§Ç",
            cancelBtn: "‡§∞‡§æ‡§á‡§° ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç",
            successTitle: "‡§∞‡§æ‡§á‡§° ‡§ï‡§®‡•ç‡§´‡§∞‡•ç‡§Æ!",
            backHomeBtn: "‡§π‡•ã‡§Æ ‡§ú‡§æ‡§è‡§Å",
            navHome: "‡§π‡•ã‡§Æ",
            navTrips: "‡§Ø‡§æ‡§§‡•ç‡§∞‡§æ‡§è‡§Å",
            navPayment: "‡§µ‡•â‡§≤‡•á‡§ü",
            navProfile: "‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤",
            loadingText: "‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ...",
            currencySymbol: "‚Çπ",
            unit: "‡§ï‡§ø‡§Æ‡•Ä",
            eta: "‡§Æ‡§ø‡§®‡§ü ‡§¶‡•Ç‡§∞"
        }
    };

    // ---------- VEHICLE DATA (with ETA) ----------
    const vehicleData = {
        trucks: [
            { icon: 'üõª', nameEn: 'Tata Ace', nameHi: '‡§ü‡§æ‡§ü‡§æ ‡§ê‡§∏', descEn: 'Small truck for light goods', descHi: '‡§π‡§≤‡•ç‡§ï‡•á ‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§õ‡•ã‡§ü‡§æ ‡§ü‡•ç‡§∞‡§ï', base: 5, perKm: 0.5, eta: 5 },
            { icon: 'üöö', nameEn: 'Pickup 8ft', nameHi: '‡§™‡§ø‡§ï‡§Ö‡§™ 8‡§´‡•Ä‡§ü', descEn: 'Medium pickup', descHi: '‡§Æ‡§ß‡•ç‡§Ø‡§Æ ‡§™‡§ø‡§ï‡§Ö‡§™', base: 12, perKm: 0.4, eta: 7 },
            { icon: 'üöõ', nameEn: '14ft Truck', nameHi: '14‡§´‡•Ä‡§ü ‡§ü‡•ç‡§∞‡§ï', descEn: 'Large truck for heavy items', descHi: '‡§≠‡§æ‡§∞‡•Ä ‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¨‡§°‡§º‡§æ ‡§ü‡•ç‡§∞‡§ï', base: 25, perKm: 0.4, eta: 10 },
            { icon: 'üü®üöú', nameEn: 'JCB', nameHi: '‡§ú‡•á‡§∏‡•Ä‡§¨‡•Ä', descEn: 'Earthmover', descHi: '‡§Ö‡§∞‡•ç‡§•‡§Æ‡•Ç‡§µ‡§∞', base: 30, perKm: 0.6, eta: 15 },
            { icon: 'üèóÔ∏è', nameEn: 'Crane', nameHi: '‡§ï‡•ç‡§∞‡•á‡§®', descEn: 'For heavy lifting', descHi: '‡§≠‡§æ‡§∞‡•Ä ‡§â‡§†‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è', base: 40, perKm: 0.8, eta: 20 },
            { icon: 'üöú', nameEn: 'Tractor', nameHi: '‡§ü‡•ç‡§∞‡•à‡§ï‡•ç‡§ü‡§∞', descEn: 'Farm tractor', descHi: '‡§ï‡•É‡§∑‡§ø ‡§ü‡•ç‡§∞‡•à‡§ï‡•ç‡§ü‡§∞', base: 18, perKm: 0.35, eta: 12 }
        ],
        '2wheeler': [
            { icon: 'üõµ', nameEn: 'Bike', nameHi: '‡§¨‡§æ‡§á‡§ï', descEn: 'Fast delivery', descHi: '‡§§‡•á‡§ú‡§º ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä', base: 0.5, perKm: 0.1, eta: 3 },
            { icon: 'üõ¥', nameEn: 'Scooty', nameHi: '‡§∏‡•ç‡§ï‡•Ç‡§ü‡•Ä', descEn: 'Economical', descHi: '‡§ï‡§ø‡§´‡§æ‡§Ø‡§§‡•Ä', base: 0.4, perKm: 0.08, eta: 4 }
        ],
        packers: [
            { icon: 'üöö', nameEn: 'Mini Truck + Labour', nameHi: '‡§Æ‡§ø‡§®‡•Ä ‡§ü‡•ç‡§∞‡§ï + ‡§≤‡•á‡§¨‡§∞', descEn: 'With 2 movers', descHi: '2 ‡§Æ‡•Ç‡§µ‡§∞‡•ç‡§∏ ‡§ï‡•á ‡§∏‡§æ‡§•', base: 15, perKm: 0.3, eta: 20 },
            { icon: 'üè†', nameEn: 'House Shifting', nameHi: '‡§π‡§æ‡§â‡§∏ ‡§∂‡§ø‡§´‡•ç‡§ü‡§ø‡§Ç‡§ó', descEn: 'Full service', descHi: '‡§™‡•Ç‡§∞‡•Ä ‡§∏‡•á‡§µ‡§æ', base: 30, perKm: 0.4, eta: 30 }
        ]
    };

    // ---------- LANGUAGE TOGGLE ----------
    window.toggleLanguage = function() {
        currentLanguage = currentLanguage === 'en' ? 'hi' : 'en';
        document.getElementById('langToggle').innerText = currentLanguage === 'en' ? 'üá∫üá∏ EN' : 'üáÆüá≥ HI';
        updateUILanguage();
        const activeTab = document.querySelector('.tab.active').dataset.category;
        loadVehicleGrid(activeTab);
    };

    function updateUILanguage() {
        const t = translations[currentLanguage];
        document.getElementById('modalTitle').innerText = t.modalTitle;
        document.getElementById('phoneNumber').placeholder = t.phonePlaceholder;
        document.getElementById('locationPlaceholder').innerText = t.locationPlaceholder;
        document.getElementById('tabTrucks').innerText = t.tabTrucks;
        document.getElementById('tab2Wheeler').innerText = t.tab2Wheeler;
        document.getElementById('tabPackers').innerText = t.tabPackers;
        document.getElementById('vehicleCategoryTitle').innerHTML = `<i class="fas fa-truck"></i> ${t.vehicleCategoryTitle}`;
        document.getElementById('bookingTitle').innerText = t.bookingTitle;
        document.getElementById('pickupLabel').innerText = t.pickupLabel;
        document.getElementById('pickupAddr').placeholder = t.pickupPlaceholder;
        document.getElementById('dropLabel').innerText = t.dropLabel;
        document.getElementById('dropAddr').placeholder = t.dropPlaceholder;
        document.getElementById('distanceLabel').innerText = t.distanceLabel;
        document.getElementById('kmInput').placeholder = t.distancePlaceholder;
        document.getElementById('useLocationBtn').innerText = t.useLocationBtn;
        document.getElementById('confirmBtn').innerText = t.confirmBtn;
        document.getElementById('historyTitle').innerText = t.historyTitle;
        document.getElementById('trackingTitle').innerText = t.trackingTitle;
        document.getElementById('cancelBtn').innerText = t.cancelBtn;
        document.getElementById('successTitle').innerText = t.successTitle;
        document.getElementById('backHomeBtn').innerText = t.backHomeBtn;
        document.getElementById('navHome').innerHTML = `<i class="fas fa-home"></i><span>${t.navHome}</span>`;
        document.getElementById('navTrips').innerHTML = `<i class="fas fa-history"></i><span>${t.navTrips}</span>`;
        document.getElementById('navPayment').innerHTML = `<i class="fas fa-wallet"></i><span>${t.navPayment}</span>`;
        document.getElementById('navProfile').innerHTML = `<i class="fas fa-user"></i><span>${t.navProfile}</span>`;
        document.getElementById('loadingText').innerText = t.loadingText;
        calculateFare();
    }

    // ---------- DEMO LOGIN ----------
    window.showLoginModal = function() {
        if (currentUser) { currentUser = null; document.getElementById('userIcon').innerHTML = `<i class="fas fa-user"></i>`; return; }
        document.getElementById('loginModal').classList.add('active');
    };

    document.getElementById('demoLoginBtn').addEventListener('click', function() {
        const phone = document.getElementById('phoneNumber').value;
        if (!phone || phone.length !== 10) {
            document.getElementById('loginError').innerText = 'Enter a 10-digit number';
            return;
        }
        currentUser = { uid: 'demo_' + phone, phoneNumber: '+1' + phone };
        document.getElementById('userIcon').innerHTML = `<i class="fas fa-user-check"></i>`;
        document.getElementById('loginModal').classList.remove('active');
        document.getElementById('loginError').innerText = '';
    });

    // ---------- SCREEN MANAGEMENT ----------
    window.showScreen = function(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach((item, idx) => {
            if (screenId === 'homeScreen' && idx === 0) item.classList.add('active');
            else if (screenId === 'historyScreen' && idx === 1) item.classList.add('active');
            else item.classList.remove('active');
        });
        if (screenId === 'historyScreen') loadHistory();
        if (screenId === 'homeScreen') loadVehicleGrid('trucks');
    };

    window.goBack = () => showScreen('homeScreen');
    window.goHome = () => showScreen('homeScreen');

    // ---------- LOAD VEHICLE GRID ----------
    function loadVehicleGrid(category) {
        const grid = document.getElementById('vehicleGrid');
        const t = translations[currentLanguage];
        let html = '';
        vehicleData[category].forEach(v => {
            const name = currentLanguage === 'en' ? v.nameEn : v.nameHi;
            const desc = currentLanguage === 'en' ? v.descEn : v.descHi;
            const eta = v.eta + ' ' + t.eta;
            html += `<div class="vehicle-card" data-name="${v.nameEn}" data-base="${v.base}" data-perkm="${v.perKm}" data-eta="${v.eta}">
                <div class="icon">${v.icon}</div>
                <div class="vehicle-info">
                    <h4>${name}</h4>
                    <p>${desc}</p>
                </div>
                <div class="vehicle-price">
                    <div class="price">${t.currencySymbol}${v.base}</div>
                    <div class="eta">${eta}</div>
                </div>
            </div>`;
        });
        grid.innerHTML = html;

        document.querySelectorAll('.vehicle-card').forEach(card => {
            card.addEventListener('click', () => {
                currentVehicle = card.dataset.name;
                basePrice = parseFloat(card.dataset.base);
                perKmRate = parseFloat(card.dataset.perkm);
                const vehicleName = currentLanguage === 'en' ? currentVehicle : (vehicleData[category].find(v => v.nameEn === currentVehicle)?.nameHi || currentVehicle);
                document.getElementById('selectedVehicleInfo').innerHTML = `üöò ${vehicleName}`;
                showScreen('bookingScreen');
                document.getElementById('kmInput').value = '';
                document.getElementById('fareAmount').innerText = t.currencySymbol + '0';
            });
        });
    }

    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            loadVehicleGrid(this.dataset.category);
        });
    });

    // ---------- FARE CALCULATION ----------
    window.calculateFare = function() {
        let km = parseFloat(document.getElementById('kmInput').value) || 0;
        const t = translations[currentLanguage];
        if (currentVehicle && currentVehicle.includes('Tata Ace')) {
            if (km <= 10) finalFare = 5;
            else if (km <= 20) finalFare = 10;
            else finalFare = km * 0.5;
        } else {
            finalFare = basePrice + (km * perKmRate);
        }
        document.getElementById('fareAmount').innerText = t.currencySymbol + finalFare.toFixed(2);
        document.getElementById('baseFare').innerText = `Base: ${t.currencySymbol}${basePrice}`;
        document.getElementById('distanceFare').innerText = `Distance: ${t.currencySymbol}${(km * perKmRate).toFixed(2)}`;
        document.getElementById('totalFare').innerText = `Total: ${t.currencySymbol}${finalFare.toFixed(2)}`;
    };

    // ---------- GPS LOCATION ----------
    window.getCurrentLocation = function() {
        if (!navigator.geolocation) { alert('Geolocation not supported'); return; }
        document.getElementById('loading').classList.add('active');
        navigator.geolocation.getCurrentPosition(async pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            document.getElementById('map').style.display = 'block';
            if (map) map.remove();
            map = L.map('map').setView([lat, lng], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            L.marker([lat, lng]).addTo(map).bindPopup('You are here').openPopup();
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await res.json();
                document.getElementById('pickupAddr').value = data.display_name || 'Location found';
            } catch(e) { }
            document.getElementById('loading').classList.remove('active');
        }, err => {
            alert('Unable to get location');
            document.getElementById('loading').classList.remove('active');
        });
    };

    // ---------- CONFIRM BOOKING ----------
    window.confirmBooking = async function() {
        if (!currentUser) { alert('Please login first'); showLoginModal(); return; }
        if (finalFare <= 0) { alert('Enter distance'); return; }
        const pickup = document.getElementById('pickupAddr').value || 'Unknown';
        const drop = document.getElementById('dropAddr').value || 'Unknown';
        const km = parseFloat(document.getElementById('kmInput').value) || 0;
        const t = translations[currentLanguage];

        const commission = Math.round(finalFare * 0.15 * 100) / 100;
        const driverAmount = finalFare - commission;

        const booking = {
            userId: currentUser.uid,
            userPhone: currentUser.phoneNumber,
            vehicle: currentVehicle,
            pickup, drop, km,
            fare: finalFare, commission, driverAmount,
            currency: t.currencySymbol,
            status: 'pending',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            document.getElementById('loading').classList.add('active');
            const docRef = await db.collection('bookings').add(booking);
            document.getElementById('loading').classList.remove('active');
            document.getElementById('successDetails').innerHTML = `
                <p><strong>Booking ID:</strong> ${docRef.id.slice(0,8)}</p>
                <p><strong>Vehicle:</strong> ${currentVehicle}</p>
                <p><strong>Fare:</strong> ${t.currencySymbol}${finalFare.toFixed(2)}</p>
                <p><strong>Pickup:</strong> ${pickup.substring(0,30)}...</p>
            `;
            showScreen('successScreen');
        } catch (e) {
            alert('Booking failed: ' + e.message);
            document.getElementById('loading').classList.remove('active');
        }
    };

    // ---------- LOAD HISTORY ----------
    window.loadHistory = async function() {
        if (!currentUser) { document.getElementById('historyList').innerHTML = '<p>Please login</p>'; return; }
        try {
            const snapshot = await db.collection('bookings')
                .where('userId', '==', currentUser.uid)
                .orderBy('timestamp', 'desc')
                .get();
            if (snapshot.empty) { document.getElementById('historyList').innerHTML = '<p>No trips yet</p>'; return; }
            let html = '';
            snapshot.forEach(doc => {
                const b = doc.data();
                const time = b.timestamp ? new Date(b.timestamp.toDate()).toLocaleString(currentLanguage === 'en' ? 'en-US' : 'hi-IN') : '';
                const currency = b.currency || (currentLanguage === 'en' ? '$' : '‚Çπ');
                html += `<div class="history-item">
                    <div class="row"><span>${b.vehicle}</span><span class="status-badge status-${b.status}">${b.status}</span></div>
                    <div class="row"><small>${b.pickup.substring(0,20)} ‚Üí ${b.drop.substring(0,20)}</small></div>
                    <div class="row"><span>${currency}${b.fare?.toFixed(2)}</span><small>${time}</small></div>
                </div>`;
            });
            document.getElementById('historyList').innerHTML = html;
        } catch(e) { document.getElementById('historyList').innerHTML = '<p>Error loading</p>'; }
    };

    window.cancelBooking = () => goHome();

    document.getElementById('loginModal').addEventListener('click', function(e) {
        if (e.target === this) this.classList.remove('active');
    });

    updateUILanguage();
    loadVehicleGrid('trucks');
</script>
</body>
</html>
