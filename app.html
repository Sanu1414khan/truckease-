<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TruckEase - Customer App</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Leaflet for map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: #f4f7fc; padding-bottom: 70px; }

        /* Header */
        .header { background: white; padding: 15px; display: flex; align-items: center; gap: 10px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .location-bar { background: #eef2ff; padding: 10px 15px; border-radius: 30px; flex: 1; font-size: 14px; color: #2854ff; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
        .user-icon { font-size: 24px; color: #2854ff; background: #eef2ff; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* Tabs */
        .tabs { display: flex; gap: 10px; padding: 15px; overflow-x: auto; background: white; border-bottom: 1px solid #eee; }
        .tab { padding: 8px 20px; border-radius: 30px; background: #f0f0f0; font-weight: 600; font-size: 14px; white-space: nowrap; cursor: pointer; transition: 0.2s; }
        .tab.active { background: #2854ff; color: white; }

        /* Vehicle Cards */
        .section-title { padding: 15px 15px 5px; font-size: 18px; font-weight: 700; }
        .vehicle-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 0 15px 15px; }
        .vehicle-card { background: white; padding: 15px; border-radius: 16px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.02); border: 1px solid #eee; cursor: pointer; transition: 0.2s; }
        .vehicle-card:hover { border-color: #2854ff; box-shadow: 0 5px 15px rgba(40,84,255,0.1); }
        .vehicle-card .icon { font-size: 40px; margin-bottom: 5px; }
        .vehicle-card h4 { font-size: 14px; font-weight: 600; margin-bottom: 3px; }
        .vehicle-card p { font-size: 12px; color: #666; }

        /* Booking Screen */
        .screen { display: none; padding: 15px; }
        .screen.active { display: block; }
        .booking-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .booking-header .back-btn { font-size: 24px; cursor: pointer; }
        .fare-box { background: #eef2ff; padding: 15px; border-radius: 16px; text-align: center; margin: 15px 0; }
        .fare-box .fare { font-size: 32px; font-weight: 800; color: #2854ff; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px; }
        .input-group input, .input-group textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 12px; font-size: 15px; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: 600; font-size: 16px; cursor: pointer; margin-top: 10px; }
        .btn-primary { background: #2854ff; color: white; }
        .btn-secondary { background: #e0e0e0; color: #333; }

        /* Map */
        #map { height: 200px; border-radius: 16px; margin: 15px 0; display: none; }

        /* History List */
        .history-item { background: white; padding: 15px; border-radius: 16px; margin-bottom: 10px; border: 1px solid #eee; }
        .history-item .row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .status-badge { padding: 4px 10px; border-radius: 30px; font-size: 12px; font-weight: 600; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }

        /* Login Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 30px; width: 90%; max-width: 350px; text-align: center; }
        .modal-content input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 12px; }
        #recaptcha-container { margin: 10px 0; }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; max-width: 450px; background: white; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #eee; left: 50%; transform: translateX(-50%); z-index: 100; }
        .nav-item { text-align: center; color: #999; font-size: 12px; cursor: pointer; }
        .nav-item.active { color: #2854ff; font-weight: 600; }
        .nav-item i { font-size: 20px; display: block; margin-bottom: 3px; }

        .loading { display: none; text-align: center; padding: 40px; }
        .loading.active { display: block; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #2854ff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<!-- Login Modal -->
<div id="loginModal" class="modal">
    <div class="modal-content">
        <h3>ðŸ“± Log in / Sign up</h3>
        <div id="phoneSection">
            <input type="tel" id="phoneNumber" placeholder="Mobile number (10 digits)" maxlength="10">
            <div id="recaptcha-container"></div>
            <button class="btn btn-primary" id="sendOtpBtn">Send OTP</button>
        </div>
        <div id="otpSection" style="display:none;">
            <input type="text" id="otpCode" placeholder="Enter OTP">
            <button class="btn btn-primary" id="verifyOtpBtn">Verify OTP</button>
        </div>
        <p id="loginError" style="color:red; font-size:12px;"></p>
    </div>
</div>

<!-- Header -->
<div class="header">
    <div class="location-bar" id="currentLocText" onclick="getCurrentLocation()">
        <i class="fas fa-map-marker-alt"></i> Set location...
    </div>
    <div class="user-icon" id="userIcon" onclick="showLoginModal()">
        <i class="fas fa-user"></i>
    </div>
</div>

<!-- Main content: different screens -->
<div id="homeScreen" class="screen active">
    <div class="tabs" id="tabContainer">
        <div class="tab active" data-category="trucks">Trucks</div>
        <div class="tab" data-category="2wheeler">2 Wheeler</div>
        <div class="tab" data-category="packers">Packers & Movers</div>
    </div>
    <h3 class="section-title" id="vehicleCategoryTitle">Mini Trucks</h3>
    <div class="vehicle-grid" id="vehicleGrid"></div>
</div>

<div id="bookingScreen" class="screen">
    <div class="booking-header">
        <i class="fas fa-arrow-left back-btn" onclick="goBack()"></i>
        <h3>Booking Details</h3>
    </div>
    <div id="selectedVehicleInfo" style="margin-bottom:15px; font-weight:600;"></div>
    <div class="input-group">
        <label>Pickup location</label>
        <input type="text" id="pickupAddr" placeholder="Enter pickup address" value="Jalpura, Greater Noida">
    </div>
    <div class="input-group">
        <label>Drop location</label>
        <input type="text" id="dropAddr" placeholder="Enter drop address">
    </div>
    <div class="input-group">
        <label>Distance (km) - or use GPS</label>
        <input type="number" id="kmInput" placeholder="Distance in km" oninput="calculateFare()">
    </div>
    <div id="map"></div>
    <button class="btn btn-secondary" onclick="getCurrentLocation()"><i class="fas fa-location-dot"></i> Use my location</button>
    <div class="fare-box">
        <span class="fare" id="fareAmount">â‚¹0</span>
        <div style="font-size:13px; color:#666;">Estimated fare</div>
    </div>
    <button class="btn btn-primary" onclick="confirmBooking()">Confirm Booking</button>
</div>

<div id="historyScreen" class="screen">
    <div class="booking-header">
        <i class="fas fa-arrow-left back-btn" onclick="goBack()"></i>
        <h3>Your Trips</h3>
    </div>
    <div id="historyList"></div>
</div>

<div id="trackingScreen" class="screen">
    <div class="booking-header">
        <i class="fas fa-arrow-left back-btn" onclick="goBack()"></i>
        <h3>Tracking</h3>
    </div>
    <div id="trackingMap" style="height:300px; border-radius:16px; margin-bottom:15px;"></div>
    <div id="trackingDetails"></div>
    <button class="btn btn-secondary" onclick="cancelBooking()">Cancel Trip</button>
</div>

<div id="successScreen" class="screen">
    <div style="text-align:center; padding:40px;">
        <i class="fas fa-check-circle" style="font-size:60px; color:#28a745;"></i>
        <h2>Booking Confirmed!</h2>
        <div id="successDetails" style="background:#e8f5e9; padding:15px; border-radius:16px; margin:20px;"></div>
        <button class="btn btn-primary" onclick="goHome()">Back to Home</button>
    </div>
</div>

<!-- Bottom Navigation -->
<div class="bottom-nav">
    <div class="nav-item active" onclick="showScreen('homeScreen')"><i class="fas fa-home"></i>Home</div>
    <div class="nav-item" onclick="showScreen('historyScreen')"><i class="fas fa-history"></i>Trips</div>
    <div class="nav-item" onclick="alert('Coming soon')"><i class="fas fa-wallet"></i>Payment</div>
    <div class="nav-item" onclick="alert('Coming soon')"><i class="fas fa-user"></i>Profile</div>
</div>

<!-- Loading spinner -->
<div id="loading" class="loading"><div class="spinner"></div><p>Loading...</p></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // ---------- FIREBASE CONFIG (same as your project) ----------
    const firebaseConfig = {
        apiKey: "AIzaSyByh4tT4zcUpjjQ_ebaYzpSulGtsDHjbw0",
        authDomain: "truckease-cb961.firebaseapp.com",
        projectId: "truckease-cb961",
        storageBucket: "truckease-cb961.firebasestorage.app",
        messagingSenderId: "558046020925",
        appId: "1:558046020925:web:573533af4bbf93841e3154"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ---------- GLOBAL VARIABLES ----------
    let currentUser = null;
    let currentVehicle = null;
    let basePrice = 0, perKmRate = 0;
    let finalFare = 0;
    let map = null, trackingMap = null;
    let recaptchaVerifier;
    let currentBookingId = null;
    let unsubscribeTracking = null;

    // ---------- AUTH STATE ----------
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            document.getElementById('userIcon').innerHTML = `<i class="fas fa-user-check"></i>`;
        } else {
            currentUser = null;
            document.getElementById('userIcon').innerHTML = `<i class="fas fa-user"></i>`;
        }
    });

    // ---------- LOGIN MODAL ----------
    window.showLoginModal = function() {
        if (currentUser) {
            auth.signOut();
            return;
        }
        document.getElementById('loginModal').classList.add('active');
        if (!recaptchaVerifier) {
            recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { size: 'invisible' });
        }
    };

    document.getElementById('sendOtpBtn').addEventListener('click', async () => {
        const phone = document.getElementById('phoneNumber').value;
        if (!phone || phone.length !== 10) {
            document.getElementById('loginError').innerText = 'Enter 10-digit mobile number';
            return;
        }
        try {
            const confirmation = await auth.signInWithPhoneNumber('+91' + phone, recaptchaVerifier);
            window.confirmationResult = confirmation;
            document.getElementById('phoneSection').style.display = 'none';
            document.getElementById('otpSection').style.display = 'block';
            document.getElementById('loginError').innerText = '';
        } catch (e) {
            document.getElementById('loginError').innerText = 'Error: ' + e.message;
        }
    });

    document.getElementById('verifyOtpBtn').addEventListener('click', async () => {
        const otp = document.getElementById('otpCode').value;
        if (!otp) return;
        try {
            await window.confirmationResult.confirm(otp);
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('phoneSection').style.display = 'block';
            document.getElementById('otpSection').style.display = 'none';
        } catch (e) {
            document.getElementById('loginError').innerText = 'Invalid OTP';
        }
    });

    // ---------- SCREEN MANAGEMENT ----------
    window.showScreen = function(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
        // update bottom nav
        document.querySelectorAll('.nav-item').forEach((item, idx) => {
            if (screenId === 'homeScreen' && idx === 0) item.classList.add('active');
            else if (screenId === 'historyScreen' && idx === 1) item.classList.add('active');
            else item.classList.remove('active');
        });
        if (screenId === 'historyScreen') loadHistory();
        if (screenId === 'homeScreen') loadVehicleGrid('trucks');
    };

    window.goBack = function() { showScreen('homeScreen'); };
    window.goHome = function() { showScreen('homeScreen'); };

    // ---------- VEHICLE GRID ----------
    const vehicleData = {
        trucks: [
            { icon: 'ðŸ›»', name: 'Tata Ace', desc: 'â‚¹500 (10km), then â‚¹50/km', base: 500, perKm: 50 },
            { icon: 'ðŸšš', name: 'Pickup 8ft', desc: 'â‚¹1200 base + â‚¹40/km', base: 1200, perKm: 40 },
            { icon: 'ðŸš›', name: '14ft Truck', desc: 'â‚¹2500 base + â‚¹40/km', base: 2500, perKm: 40 },
            { icon: 'ðŸŸ¨ðŸšœ', name: 'JCB', desc: 'â‚¹3000 base + â‚¹60/km', base: 3000, perKm: 60 },
            { icon: 'ðŸ—ï¸', name: 'Crane', desc: 'â‚¹4000 base + â‚¹80/km', base: 4000, perKm: 80 },
            { icon: 'ðŸšœ', name: 'Tractor', desc: 'â‚¹1800 base + â‚¹35/km', base: 1800, perKm: 35 }
        ],
        '2wheeler': [
            { icon: 'ðŸ›µ', name: 'Bike', desc: 'â‚¹50 base + â‚¹10/km', base: 50, perKm: 10 },
            { icon: 'ðŸ›´', name: 'Scooty', desc: 'â‚¹40 base + â‚¹8/km', base: 40, perKm: 8 }
        ],
        packers: [
            { icon: 'ðŸšš', name: 'Mini Truck + Labour', desc: 'â‚¹1500 base + â‚¹30/km', base: 1500, perKm: 30 },
            { icon: 'ðŸ ', name: 'House Shifting', desc: 'â‚¹3000 base + â‚¹40/km', base: 3000, perKm: 40 }
        ]
    };

    function loadVehicleGrid(category) {
        const grid = document.getElementById('vehicleGrid');
        const title = document.getElementById('vehicleCategoryTitle');
        if (category === 'trucks') title.innerText = 'Mini Trucks';
        else if (category === '2wheeler') title.innerText = '2 Wheeler';
        else title.innerText = 'Packers & Movers';

        let html = '';
        vehicleData[category].forEach(v => {
            html += `<div class="vehicle-card" data-name="${v.name}" data-base="${v.base}" data-perkm="${v.perKm}">
                <div class="icon">${v.icon}</div>
                <h4>${v.name}</h4>
                <p>${v.desc}</p>
            </div>`;
        });
        grid.innerHTML = html;

        // attach click
        document.querySelectorAll('.vehicle-card').forEach(card => {
            card.addEventListener('click', () => {
                currentVehicle = card.dataset.name;
                basePrice = parseInt(card.dataset.base);
                perKmRate = parseInt(card.dataset.perkm);
                document.getElementById('selectedVehicleInfo').innerHTML = `<strong>Selected:</strong> ${currentVehicle}`;
                showScreen('bookingScreen');
                document.getElementById('kmInput').value = '';
                document.getElementById('fareAmount').innerText = 'â‚¹0';
            });
        });
    }

    // tab switching
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            loadVehicleGrid(this.dataset.category);
        });
    });

    // initial load
    loadVehicleGrid('trucks');

    // ---------- FARE CALCULATION ----------
    window.calculateFare = function() {
        let km = parseFloat(document.getElementById('kmInput').value) || 0;
        if (currentVehicle && currentVehicle.includes('Tata Ace')) {
            if (km <= 10) finalFare = 500;
            else if (km <= 20) finalFare = 1000;
            else finalFare = km * 50;
        } else {
            finalFare = basePrice + (km * perKmRate);
        }
        document.getElementById('fareAmount').innerText = 'â‚¹' + finalFare;
    };

    // ---------- GPS LOCATION (free Nominatim) ----------
    window.getCurrentLocation = function() {
        if (!navigator.geolocation) { alert('Geolocation not supported'); return; }
        document.getElementById('loading').classList.add('active');
        navigator.geolocation.getCurrentPosition(async pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            // show map
            const mapDiv = document.getElementById('map');
            mapDiv.style.display = 'block';
            if (map) map.remove();
            map = L.map('map').setView([lat, lng], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            L.marker([lat, lng]).addTo(map).bindPopup('You are here').openPopup();

            // reverse geocode
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await res.json();
                document.getElementById('pickupAddr').value = data.display_name || 'Location found';
            } catch(e) { /* ignore */ }
            document.getElementById('loading').classList.remove('active');
        }, err => {
            alert('Unable to get location');
            document.getElementById('loading').classList.remove('active');
        });
    };

    // ---------- CONFIRM BOOKING ----------
    window.confirmBooking = async function() {
        if (!currentUser) { alert('Please login first'); showLoginModal(); return; }
        if (finalFare <= 0) { alert('Enter distance or wait for fare calculation'); return; }
        const pickup = document.getElementById('pickupAddr').value || 'Unknown';
        const drop = document.getElementById('dropAddr').value || 'Unknown';
        const km = parseFloat(document.getElementById('kmInput').value) || 0;

        const commission = Math.round(finalFare * 0.15);
        const driverAmount = finalFare - commission;

        const booking = {
            userId: currentUser.uid,
            userPhone: currentUser.phoneNumber,
            vehicle: currentVehicle,
            pickup,
            drop,
            km,
            fare: finalFare,
            commission,
            driverAmount,
   
