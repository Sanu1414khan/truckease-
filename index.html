<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TruckEase - Porter Style</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --porter-blue: #2854ff; --porter-light-blue: #eef2ff; --text-dark: #1a1a1a; --text-gray: #666; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { background-color: #f8f9fd; color: var(--text-dark); padding-bottom: 70px; }

        /* Header */
        .header { background: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .location-bar { background: var(--porter-light-blue); padding: 8px 12px; border-radius: 8px; flex: 1; margin-right: 15px; font-size: 13px; color: var(--porter-blue); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }

        /* Tabs */
        .tabs-container { background: white; display: flex; padding: 10px; gap: 10px; overflow-x: auto; }
        .tab { padding: 10px 20px; border-radius: 20px; background: #f0f0f0; font-size: 14px; font-weight: 600; white-space: nowrap; cursor: pointer; border: none; }
        .tab.active { background: var(--porter-blue); color: white; }

        /* Cards */
        .section-title { padding: 15px; font-size: 18px; font-weight: 700; }
        .card-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 0 15px; }
        .service-card { background: white; padding: 15px; border-radius: 12px; border: 1px solid #eee; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.02); cursor: pointer; transition: 0.2s; }
        .service-card:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.05); border-color: var(--porter-blue); }
        .service-card h4 { font-size: 14px; margin-top: 5px; }
        .service-card p { font-size: 11px; color: gray; }

        /* Rewards Card */
        .rewards-card { margin: 15px; background: #fff5e6; padding: 15px; border-radius: 12px; border: 1px dashed #ff9f00; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .rewards-card h4 { color: #c47b00; margin-bottom: 4px; }
        .rewards-card p { font-size: 12px; }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; max-width: 450px; background: white; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #eee; z-index: 1000; left: 50%; transform: translateX(-50%); }
        .nav-item { text-align: center; color: var(--text-gray); font-size: 11px; cursor: pointer; flex: 1; }
        .nav-item.active { color: var(--porter-blue); font-weight: 700; }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 2px; }

        /* Screens */
        .screen { display: none; padding: 0 0 20px 0; }
        .screen.active { display: block; }

        /* Buttons */
        .btn-main { background: var(--porter-blue); color: white; width: 100%; padding: 15px; border-radius: 10px; border: none; font-size: 16px; font-weight: 600; margin-top: 20px; cursor: pointer; }
        .btn-secondary { background: #f0f0f0; color: var(--text-dark); width: 100%; padding: 15px; border-radius: 10px; border: none; font-size: 16px; font-weight: 500; margin-top: 10px; cursor: pointer; }
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; }
        .hidden { display: none; }
        #map { height: 200px; border-radius: 12px; margin: 10px 0; display: none; }
        .fare-box { background: #e8f0fe; padding: 15px; border-radius: 12px; text-align: center; margin: 15px 0; }
        .fare-box span { font-size: 28px; font-weight: 800; color: var(--porter-blue); }
        .commission-note { background: #fef5e7; padding: 8px; border-radius: 8px; font-size: 13px; color: #b95b0d; text-align: center; margin-top: 10px; }
        #addressDisplay { background: #fffde7; padding: 10px; border-radius: 8px; margin: 10px 0; display: none; }
    </style>
</head>
<body>

    <!-- Header (common) -->
    <div class="header">
        <div class="location-bar" id="currentLocText" onclick="getCurrentLocation()">üìç ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç...</div>
        <div style="font-size: 22px;">üë§</div>
    </div>

    <!-- ========== HOME SCREEN ========== -->
    <div id="homeScreen" class="screen active">
        <div class="tabs-container">
            <button class="tab active" data-tab="trucks">Trucks</button>
            <button class="tab" data-tab="2wheeler">2 Wheeler</button>
            <button class="tab" data-tab="packers">Packers & Movers</button>
        </div>

        <h3 class="section-title" id="vehicleSectionTitle">‡§õ‡•ã‡§ü‡•á ‡§ü‡•ç‡§∞‡§ï</h3>
        <div class="card-grid" id="vehicleGrid">
            <!-- Trucks (default) -->
            <div class="service-card" data-vehicle="Tata Ace" data-baseprice="500" data-perkm="50">
                <div style="font-size: 40px;">üõª</div>
                <h4>Tata Ace</h4>
                <p>‚Çπ500 (10km), ‡§´‡§ø‡§∞ ‚Çπ50/km</p>
            </div>
            <div class="service-card" data-vehicle="Pickup 8ft" data-baseprice="1200" data-perkm="40">
                <div style="font-size: 40px;">üöö</div>
                <h4>Pickup 8ft</h4>
                <p>‚Çπ1200 ‡§¨‡•á‡§∏ + ‚Çπ40/km</p>
            </div>
            <div class="service-card" data-vehicle="14ft Truck" data-baseprice="2500" data-perkm="40">
                <div style="font-size: 40px;">üöõ</div>
                <h4>14ft Truck</h4>
                <p>‚Çπ2500 ‡§¨‡•á‡§∏ + ‚Çπ40/km</p>
            </div>
            <div class="service-card" data-vehicle="JCB" data-baseprice="3000" data-perkm="60">
                <div style="font-size: 40px;">üü®üöú</div>
                <h4>JCB</h4>
                <p>‚Çπ3000 ‡§¨‡•á‡§∏ + ‚Çπ60/km</p>
            </div>
            <div class="service-card" data-vehicle="Crane" data-baseprice="4000" data-perkm="80">
                <div style="font-size: 40px;">üèóÔ∏è</div>
                <h4>Crane</h4>
                <p>‚Çπ4000 ‡§¨‡•á‡§∏ + ‚Çπ80/km</p>
            </div>
            <div class="service-card" data-vehicle="Tractor" data-baseprice="1800" data-perkm="35">
                <div style="font-size: 40px;">üöú</div>
                <h4>Tractor</h4>
                <p>‚Çπ1800 ‡§¨‡•á‡§∏ + ‚Çπ35/km</p>
            </div>
        </div>

        <!-- Rewards Card -->
        <div class="rewards-card" onclick="alert('‡§∞‡§ø‡§µ‡•â‡§∞‡•ç‡§°‡•ç‡§∏ ‡§∏‡•á‡§ï‡•ç‡§∂‡§® ‡§ú‡§≤‡•ç‡§¶ ‡§Ü ‡§∞‡§π‡§æ ‡§π‡•à!')">
            <div>
                <h4>Porter Rewards üèÜ</h4>
                <p>‡§π‡§∞ ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§™‡§∞ ‡§∏‡§ø‡§ï‡•ç‡§ï‡•á ‡§ú‡•Ä‡§§‡•á‡§Ç!</p>
            </div>
            <span style="color:#ff9f00;">‚Üí</span>
        </div>

        <!-- Driver Registration Card -->
        <div style="margin: 15px;">
            <button class="btn-secondary" onclick="changeScreen('driverRegScreen')">üöõ ‡§°‡•ç‡§∞‡§æ‡§á‡§µ‡§∞ ‡§¨‡§®‡•á‡§Ç / ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§ï‡§∞‡•á‡§Ç</button>
        </div>
    </div>

    <!-- ========== BOOKING SCREEN ========== -->
    <div id="bookingScreen" class="screen">
        <h3 style="padding: 15px 15px 0;">‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§°‡§ø‡§ü‡•á‡§≤‡•ç‡§∏</h3>
        <div style="padding: 15px;">
            <p id="selectedVehicleDisplay" style="font-weight: 600; margin-bottom: 15px;"></p>
            <input type="text" id="pickupAddr" placeholder="‡§ï‡§π‡§æ‡§Å ‡§∏‡•á ‡§â‡§†‡§æ‡§®‡§æ ‡§π‡•à?" value="Jalpura, Greater Noida">
            <input type="text" id="dropAddr" placeholder="‡§ï‡§π‡§æ‡§Å ‡§õ‡•ã‡•ú‡§®‡§æ ‡§π‡•à?">
            <input type="number" id="kmInput" placeholder="‡§ï‡§ø‡§≤‡•ã‡§Æ‡•Ä‡§ü‡§∞ (KM)" oninput="calculateFare()">
            
            <div class="fare-box">
                <span id="fareAmount">‚Çπ0</span>
                <div class="commission-note" id="commissionNote">15% ‡§ê‡§™ ‡§ï‡§Æ‡•Ä‡§∂‡§®: ‚Çπ0</div>
            </div>

            <button class="btn-main" onclick="getCurrentLocation()">üìç GPS ‡§∏‡•á ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§≤‡•á‡§Ç</button>
            <div id="addressDisplay"></div>
            <div id="map"></div>

            <button class="btn-main" onclick="confirmBooking()">‚úÖ ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§ï‡§®‡•ç‡§´‡§∞‡•ç‡§Æ ‡§ï‡§∞‡•á‡§Ç</button>
            <button class="btn-secondary" onclick="changeScreen('homeScreen')">‚Üê ‡§µ‡§æ‡§™‡§∏</button>
        </div>
    </div>

    <!-- ========== DRIVER REGISTRATION SCREEN ========== -->
    <div id="driverRegScreen" class="screen">
        <h3 style="padding: 15px 15px 0;">üöõ ‡§°‡•ç‡§∞‡§æ‡§á‡§µ‡§∞ ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•á‡§∂‡§®</h3>
        <div style="padding: 15px;">
            <input type="text" id="driverName" placeholder="‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ">
            <input type="tel" id="driverMobile" placeholder="‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞" maxlength="10">
            <input type="text" id="driverVehicleNum" placeholder="‡§ó‡§æ‡§°‡§º‡•Ä ‡§ï‡§æ ‡§®‡§Ç‡§¨‡§∞">
            <select id="driverVehicleType">
                <option value="Tata Ace">Tata Ace</option>
                <option value="Pickup">Pickup</option>
                <option value="Truck">Truck</option>
                <option value="JCB">JCB</option>
                <option value="Crane">Crane</option>
                <option value="Tractor">Tractor</option>
            </select>
            <input type="text" id="driverAadhaar" placeholder="‡§Ü‡§ß‡§æ‡§∞ ‡§®‡§Ç‡§¨‡§∞ (12 ‡§Ö‡§Ç‡§ï)" maxlength="12">
            <button class="btn-main" onclick="registerDriver()">‚úÖ ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§ï‡§∞‡•á‡§Ç</button>
            <button class="btn-secondary" onclick="changeScreen('homeScreen')">‚Üê ‡§µ‡§æ‡§™‡§∏</button>
        </div>
    </div>

    <!-- ========== HISTORY SCREEN ========== -->
    <div id="historyScreen" class="screen">
        <h3 style="padding: 15px 15px 0;">üìú ‡§Ü‡§™‡§ï‡•Ä ‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó</h3>
        <div id="historyList" style="padding: 15px;"></div>
        <button class="btn-secondary" onclick="changeScreen('homeScreen')">‚Üê ‡§µ‡§æ‡§™‡§∏</button>
    </div>

    <!-- ========== SUCCESS SCREEN ========== -->
    <div id="successScreen" class="screen">
        <div style="text-align: center; padding: 40px 15px;">
            <span style="font-size: 60px;">‚úÖ</span>
            <h2>‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§∏‡§´‡§≤!</h2>
            <div id="successDetails" style="background: #e8f5e9; padding: 15px; border-radius: 12px; margin: 20px 0;"></div>
            <button class="btn-main" onclick="changeScreen('homeScreen')">üè† ‡§π‡•ã‡§Æ ‡§ú‡§æ‡§è‡§Å</button>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="changeScreen('homeScreen')"><span class="nav-icon">üè†</span>Home</div>
        <div class="nav-item" onclick="showHistory()"><span class="nav-icon">üì¶</span>Orders</div>
        <div class="nav-item" onclick="alert('‡§ú‡§≤‡•ç‡§¶ ‡§Ü ‡§∞‡§π‡§æ ‡§π‡•à')"><span class="nav-icon">üí∞</span>Coins</div>
        <div class="nav-item" onclick="alert('‡§ú‡§≤‡•ç‡§¶ ‡§Ü ‡§∞‡§π‡§æ ‡§π‡•à')"><span class="nav-icon">üí≥</span>Payment</div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Main App Script -->
    <script>
        // ---------- FIREBASE CONFIG (‡§§‡•Å‡§Æ‡•ç‡§π‡§æ‡§∞‡•Ä ‡§¶‡•Ä ‡§π‡•Å‡§à) ----------
        const firebaseConfig = {
            apiKey: "AIzaSyByh4tT4zcUpjjQ_ebaYzpSulGtsDHjbw0",
            authDomain: "truckease-cb961.firebaseapp.com",
            projectId: "truckease-cb961",
            storageBucket: "truckease-cb961.firebasestorage.app",
            messagingSenderId: "558046020925",
            appId: "1:558046020925:web:573533af4bbf93841e3154"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ---------- GLOBAL VARIABLES ----------
        let currentUser = localStorage.getItem('truckUser') || '';
        let selectedVehicle = '';
        let basePrice = 0;
        let perKmRate = 0;
        let finalFare = 0;
        let userLocation = null;
        let map = null;

        // ---------- SCREEN MANAGEMENT ----------
        window.changeScreen = function(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');

            // Update bottom nav active state
            document.querySelectorAll('.nav-item').forEach((item, index) => {
                if (screenId === 'homeScreen' && index === 0) item.classList.add('active');
                else if (screenId === 'historyScreen' && index === 1) item.classList.add('active');
                else item.classList.remove('active');
            });

            // Load history if history screen
            if (screenId === 'historyScreen') loadHistory();
        };

        // ---------- TAB SWITCHING ----------
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                const tabType = this.getAttribute('data-tab');
                updateVehicleGrid(tabType);
            });
        });

        function updateVehicleGrid(tab) {
            const grid = document.getElementById('vehicleGrid');
            const title = document.getElementById('vehicleSectionTitle');
            if (tab === 'trucks') {
                title.innerText = '‡§õ‡•ã‡§ü‡•á ‡§ü‡•ç‡§∞‡§ï';
                grid.innerHTML = `
                    <div class="service-card" data-vehicle="Tata Ace" data-baseprice="500" data-perkm="50"><div style="font-size:40px;">üõª</div><h4>Tata Ace</h4><p>‚Çπ500 (10km), ‡§´‡§ø‡§∞ ‚Çπ50/km</p></div>
                    <div class="service-card" data-vehicle="Pickup 8ft" data-baseprice="1200" data-perkm="40"><div style="font-size:40px;">üöö</div><h4>Pickup 8ft</h4><p>‚Çπ1200 ‡§¨‡•á‡§∏ + ‚Çπ40/km</p></div>
                    <div class="service-card" data-vehicle="14ft Truck" data-baseprice="2500" data-perkm="40"><div style="font-size:40px;">üöõ</div><h4>14ft Truck</h4><p>‚Çπ2500 ‡§¨‡•á‡§∏ + ‚Çπ40/km</p></div>
                    <div class="service-card" data-vehicle="JCB" data-baseprice="3000" data-perkm="60"><div style="font-size:40px;">üü®üöú</div><h4>JCB</h4><p>‚Çπ3000 ‡§¨‡•á‡§∏ + ‚Çπ60/km</p></div>
                    <div class="service-card" data-vehicle="Crane" data-baseprice="4000" data-perkm="80"><div style="font-size:40px;">üèóÔ∏è</div><h4>Crane</h4><p>‚Çπ4000 ‡§¨‡•á‡§∏ + ‚Çπ80/km</p></div>
                    <div class="service-card" data-vehicle="Tractor" data-baseprice="1800" data-perkm="35"><div style="font-size:40px;">üöú</div><h4>Tractor</h4><p>‚Çπ1800 ‡§¨‡•á‡§∏ + ‚Çπ35/km</p></div>
                `;
            } else if (tab === '2wheeler') {
                title.innerText = '‡§¶‡•ã ‡§™‡§π‡§ø‡§Ø‡§æ';
                grid.innerHTML = `
                    <div class="service-card" data-vehicle="Bike" data-baseprice="50" data-perkm="10"><div style="font-size:40px;">üõµ</div><h4>Bike</h4><p>‚Çπ50 ‡§¨‡•á‡§∏ + ‚Çπ10/km</p></div>
                    <div class="service-card" data-vehicle="Scooty" data-baseprice="40" data-perkm="8"><div style="font-size:40px;">üõ¥</div><h4>Scooty</h4><p>‚Çπ40 ‡§¨‡•á‡§∏ + ‚Çπ8/km</p></div>
                `;
            } else if (tab === 'packers') {
                title.innerText = '‡§™‡•à‡§ï‡§∞‡•ç‡§∏ ‡§è‡§Ç‡§° ‡§Æ‡•Ç‡§µ‡§∞‡•ç‡§∏';
                grid.innerHTML = `
                    <div class="service-card" data-vehicle="Mini Truck with Labour" data-baseprice="1500" data-perkm="30"><div style="font-size:40px;">üöö</div><h4>Mini Truck + Labour</h4><p>‚Çπ1500 ‡§¨‡•á‡§∏ + ‚Çπ30/km</p></div>
                    <div class="service-card" data-vehicle="House Shifting" data-baseprice="3000" data-perkm="40"><div style="font-size:40px;">üè†</div><h4>House Shifting</h4><p>‚Çπ3000 ‡§¨‡•á‡§∏ + ‚Çπ40/km</p></div>
                `;
            }
            attachVehicleCardEvents();
        }

        function attachVehicleCardEvents() {
            document.querySelectorAll('.service-card').forEach(card => {
                card.addEventListener('click', function() {
                    selectedVehicle = this.getAttribute('data-vehicle');
                    basePrice = parseInt(this.getAttribute('data-baseprice'));
                    perKmRate = parseInt(this.getAttribute('data-perkm'));
                    document.getElementById('selectedVehicleDisplay').innerText = '‡§ó‡§æ‡§°‡§º‡•Ä: ' + selectedVehicle;
                    changeScreen('bookingScreen');
                    document.getElementById('kmInput').value = '';
                    document.getElementById('fareAmount').innerText = '‚Çπ0';
                    document.getElementById('commissionNote').innerText = '15% ‡§ê‡§™ ‡§ï‡§Æ‡•Ä‡§∂‡§®: ‚Çπ0';
                });
            });
        }
        attachVehicleCardEvents();

        // ---------- FARE CALCULATION ----------
        window.calculateFare = function() {
            let km = parseFloat(document.getElementById('kmInput').value) || 0;
            if (selectedVehicle.includes('Tata Ace')) {
                if (km <= 10) finalFare = 500;
                else if (km <= 20) finalFare = 1000;
                else finalFare = km * 50;
            } else {
                finalFare = basePrice + (km * perKmRate);
            }
            let commission = Math.round(finalFare * 0.15);
            document.getElementById('fareAmount').innerText = '‚Çπ' + finalFare;
            document.getElementById('commissionNote').innerHTML = `15% ‡§ê‡§™ ‡§ï‡§Æ‡•Ä‡§∂‡§®: ‚Çπ${commission}<br>‡§°‡•ç‡§∞‡§æ‡§á‡§µ‡§∞ ‡§ï‡•ã ‡§Æ‡§ø‡§≤‡•á‡§Ç‡§ó‡•á: ‚Çπ${finalFare - commission}`;
        };

        // ---------- GPS LOCATION ----------
        window.getCurrentLocation = function() {
            const addrDiv = document.getElementById('addressDisplay');
            const mapDiv = document.getElementById('map');
            if (!navigator.geolocation) {
                alert('GPS ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à');
                return;
            }
            addrDiv.style.display = 'block';
            addrDiv.innerText = '‚è≥ ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§¢‡•Ç‡§Å‡§¢ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...';
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                userLocation = { lat, lon };
                mapDiv.style.display = 'block';
                if (map) map.remove();
                map = L.map('map').setView([lat, lon], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                L.marker([lat, lon]).addTo(map).bindPopup('‡§Ü‡§™ ‡§Ø‡§π‡§æ‡§Å ‡§π‡•à‡§Ç').openPopup();

                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`, {
                        headers: { 'User-Agent': 'TruckEase/1.0' }
                    });
                    const data = await res.json();
                    addrDiv.innerText = 'üìç ' + (data.display_name || '‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§Æ‡§ø‡§≤‡•Ä');
                    document.getElementById('pickupAddr').value = data.display_name || 'Jalpura, Greater Noida';
                } catch(e) {
                    addrDiv.innerText = 'üìç ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§Æ‡§ø‡§≤ ‡§ó‡§à (‡§™‡§§‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ)';
                }
            }, () => {
                addrDiv.innerText = '‚ùå ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä';
            });
        };

        // ---------- CONFIRM BOOKING ----------
        window.confirmBooking = async function() {
            if (finalFare <= 0) { alert('‡§™‡§π‡§≤‡•á ‡§¶‡•Ç‡§∞‡•Ä ‡§°‡§æ‡§≤‡•á‡§Ç'); return; }
            if (!currentUser) {
                let mobile = prompt('‡§Ö‡§™‡§®‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§°‡§æ‡§≤‡•á‡§Ç (10 ‡§Ö‡§Ç‡§ï):');
                if (!mobile || mobile.length !== 10) { alert('‡§∏‡§π‡•Ä ‡§®‡§Ç‡§¨‡§∞ ‡§°‡§æ‡§≤‡•á‡§Ç'); return; }
                currentUser = mobile;
                localStorage.setItem('truckUser', mobile);
            }
            let pickup = document.getElementById('pickupAddr').value || '‡§ú‡•ç‡§û‡§æ‡§§ ‡§®‡§π‡•Ä‡§Ç';
            let drop = document.getElementById('dropAddr').value || '‡§ú‡•ç‡§û‡§æ‡§§ ‡§®‡§π‡•Ä‡§Ç';
            let bookingId = 'TKE' + Math.floor(1000 + Math.random() * 9000);
            let booking = {
                id: bookingId,
                user: currentUs

                <!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<!-- Main App Script -->
<script>
    // ---------- FIREBASE CONFIG (‡§§‡•Å‡§Æ‡•ç‡§π‡§æ‡§∞‡•Ä ‡§¶‡•Ä ‡§π‡•Å‡§à) ----------
    const firebaseConfig = {
        apiKey: "AIzaSyByh4tT4zcUpjjQ_ebaYzpSulGtsDHjbw0",
        authDomain: "truckease-cb961.firebaseapp.com",
        projectId: "truckease-cb961",
        storageBucket: "truckease-cb961.firebasestorage.app",
        messagingSenderId: "558046020925",
        appId: "1:558046020925:web:573533af4bbf93841e3154"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ---------- GLOBAL VARIABLES ----------
    let currentUser = localStorage.getItem('truckUser') || '';
    let selectedVehicle = '';
    let basePrice = 0;
    let perKmRate = 0;
    let finalFare = 0;
    let userLocation = null;
    let map = null;

    // ---------- SCREEN MANAGEMENT ----------
    window.changeScreen = function(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');

        // Update bottom nav active state
        document.querySelectorAll('.nav-item').forEach((item, index) => {
            if (screenId === 'homeScreen' && index === 0) item.classList.add('active');
            else if (screenId === 'historyScreen' && index === 1) item.classList.add('active');
            else item.classList.remove('active');
        });

        // Load history if history screen
        if (screenId === 'historyScreen') loadHistory();
    };

    // ---------- TAB SWITCHING ----------
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            const tabType = this.getAttribute('data-tab');
            updateVehicleGrid(tabType);
        });
    });

    function updateVehicleGrid(tab) {
        const grid = document.getElementById('vehicleGrid');
        const title = document.getElementById('vehicleSectionTitle');
        if (tab === 'trucks') {
            title.innerText = '‡§õ‡•ã‡§ü‡•á ‡§ü‡•ç‡§∞‡§ï';
            grid.innerHTML = `
                <div class="service-card" data-vehicle="Tata Ace" data-baseprice="500" data-perkm="50"><div style="font-size:40px;">üõª</div><h4>Tata Ace</h4><p>‚Çπ500 (10km), ‡§´‡§ø‡§∞ ‚Çπ50/km</p></div>
                <div class="service-card" data-vehicle="Pickup 8ft" data-baseprice="1200" data-perkm="40"><div style="font-size:40px;">üöö</div><h4>Pickup 8ft</h4><p>‚Çπ1200 ‡§¨‡•á‡§∏ + ‚Çπ40/km</p></div>
                <div class="service-card" data-vehicle="14ft Truck" data-baseprice="2500" data-perkm="40"><div style="font-size:40px;">üöõ</div><h4>14ft Truck</h4><p>‚Çπ2500 ‡§¨‡•á‡§∏ + ‚Çπ40/km</p></div>
                <div class="service-card" data-vehicle="JCB" data-baseprice="3000" data-perkm="60"><div style="font-size:40px;">üü®üöú</div><h4>JCB</h4><p>‚Çπ3000 ‡§¨‡•á‡§∏ + ‚Çπ60/km</p></div>
                <div class="service-card" data-vehicle="Crane" data-baseprice="4000" data-perkm="80"><div style="font-size:40px;">üèóÔ∏è</div><h4>Crane</h4><p>‚Çπ4000 ‡§¨‡•á‡§∏ + ‚Çπ80/km</p></div>
                <div class="service-card" data-vehicle="Tractor" data-baseprice="1800" data-perkm="35"><div style="font-size:40px;">üöú</div><h4>Tractor</h4><p>‚Çπ1800 ‡§¨‡•á‡§∏ + ‚Çπ35/km</p></div>
            `;
        } else if (tab === '2wheeler') {
            title.innerText = '‡§¶‡•ã ‡§™‡§π‡§ø‡§Ø‡§æ';
            grid.innerHTML = `
                <div class="service-card" data-vehicle="Bike" data-baseprice="50" data-perkm="10"><div style="font-size:40px;">üõµ</div><h4>Bike</h4><p>‚Çπ50 ‡§¨‡•á‡§∏ + ‚Çπ10/km</p></div>
                <div class="service-card" data-vehicle="Scooty" data-baseprice="40" data-perkm="8"><div style="font-size:40px;">üõ¥</div><h4>Scooty</h4><p>‚Çπ40 ‡§¨‡•á‡§∏ + ‚Çπ8/km</p></div>
            `;
        } else if (tab === 'packers') {
            title.innerText = '‡§™‡•à‡§ï‡§∞‡•ç‡§∏ ‡§è‡§Ç‡§° ‡§Æ‡•Ç‡§µ‡§∞‡•ç‡§∏';
            grid.innerHTML = `
                <div class="service-card" data-vehicle="Mini Truck with Labour" data-baseprice="1500" data-perkm="30"><div style="font-size:40px;">üöö</div><h4>Mini Truck + Labour</h4><p>‚Çπ1500 ‡§¨‡•á‡§∏ + ‚Çπ30/km</p></div>
                <div class="service-card" data-vehicle="House Shifting" data-baseprice="3000" data-perkm="40"><div style="font-size:40px;">üè†</div><h4>House Shifting</h4><p>‚Çπ3000 ‡§¨‡•á‡§∏ + ‚Çπ40/km</p></div>
            `;
        }
        attachVehicleCardEvents();
    }

    function attachVehicleCardEvents() {
        document.querySelectorAll('.service-card').forEach(card => {
            card.addEventListener('click', function() {
                selectedVehicle = this.getAttribute('data-vehicle');
                basePrice = parseInt(this.getAttribute('data-baseprice'));
                perKmRate = parseInt(this.getAttribute('data-perkm'));
                document.getElementById('selectedVehicleDisplay').innerText = '‡§ó‡§æ‡§°‡§º‡•Ä: ' + selectedVehicle;
                changeScreen('bookingScreen');
                document.getElementById('kmInput').value = '';
                document.getElementById('fareAmount').innerText = '‚Çπ0';
                document.getElementById('commissionNote').innerText = '15% ‡§ê‡§™ ‡§ï‡§Æ‡•Ä‡§∂‡§®: ‚Çπ0';
            });
        });
    }
    attachVehicleCardEvents();

    // ---------- FARE CALCULATION ----------
    window.calculateFare = function() {
        let km = parseFloat(document.getElementById('kmInput').value) || 0;
        if (selectedVehicle.includes('Tata Ace')) {
            if (km <= 10) finalFare = 500;
            else if (km <= 20) finalFare = 1000;
            else finalFare = km * 50;
        } else {
            finalFare = basePrice + (km * perKmRate);
        }
        let commission = Math.round(finalFare * 0.15);
        document.getElementById('fareAmount').innerText = '‚Çπ' + finalFare;
        document.getElementById('commissionNote').innerHTML = `15% ‡§ê‡§™ ‡§ï‡§Æ‡•Ä‡§∂‡§®: ‚Çπ${commission}<br>‡§°‡•ç‡§∞‡§æ‡§á‡§µ‡§∞ ‡§ï‡•ã ‡§Æ‡§ø‡§≤‡•á‡§Ç‡§ó‡•á: ‚Çπ${finalFare - commission}`;
    };

    // ---------- GPS LOCATION ----------
    window.getCurrentLocation = function() {
        const addrDiv = document.getElementById('addressDisplay');
        const mapDiv = document.getElementById('map');
        if (!navigator.geolocation) {
            alert('GPS ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à');
            return;
        }
        addrDiv.style.display = 'block';
        addrDiv.innerText = '‚è≥ ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§¢‡•Ç‡§Å‡§¢ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...';
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            userLocation = { lat, lon };
            mapDiv.style.display = 'block';
            if (map) map.remove();
            map = L.map('map').setView([lat, lon], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            L.marker([lat, lon]).addTo(map).bindPopup('‡§Ü‡§™ ‡§Ø‡§π‡§æ‡§Å ‡§π‡•à‡§Ç').openPopup();

            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`, {
                    headers: { 'User-Agent': 'TruckEase/1.0' }
                });
                const data = await res.json();
                addrDiv.innerText = 'üìç ' + (data.display_name || '‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§Æ‡§ø‡§≤‡•Ä');
                document.getElementById('pickupAddr').value = data.display_name || 'Jalpura, Greater Noida';
            } catch(e) {
                addrDiv.innerText = 'üìç ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§Æ‡§ø‡§≤ ‡§ó‡§à (‡§™‡§§‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ)';
            }
        }, () => {
            addrDiv.innerText = '‚ùå ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä';
        });
    };

        // ---------- CONFIRM BOOKING (‡§™‡•Ç‡§∞‡§æ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®) ----------
    window.confirmBooking = async function() {
        if (finalFare <= 0) { 
            alert('‡§™‡§π‡§≤‡•á ‡§¶‡•Ç‡§∞‡•Ä ‡§°‡§æ‡§≤‡•á‡§Ç'); 
            return; 
        }
        
        // ‡§Ö‡§ó‡§∞ ‡§Ø‡•Ç‡§ú‡§∞ ‡§≤‡•â‡§ó‡§ø‡§® ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à ‡§§‡•ã ‡§®‡§Ç‡§¨‡§∞ ‡§Æ‡§æ‡§Ç‡§ó‡•ã
        if (!currentUser) {
            let mobile = prompt('‡§Ö‡§™‡§®‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§°‡§æ‡§≤‡•á‡§Ç (10 ‡§Ö‡§Ç‡§ï):');
            if (!mobile || mobile.length !== 10) { 
                alert('‡§∏‡§π‡•Ä 10 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§®‡§Ç‡§¨‡§∞ ‡§°‡§æ‡§≤‡•á‡§Ç'); 
                return; 
            }
            currentUser = mobile;
            localStorage.setItem('truckUser', mobile);
            document.getElementById('currentLocText').innerHTML = 'üìç ' + mobile;
        }
        
        let pickup = document.getElementById('pickupAddr').value || '‡§ú‡•ç‡§û‡§æ‡§§ ‡§®‡§π‡•Ä‡§Ç';
        let drop = document.getElementById('dropAddr').value || '‡§ú‡•ç‡§û‡§æ‡§§ ‡§®‡§π‡•Ä‡§Ç';
        let bookingId = 'TKE' + Math.floor(1000 + Math.random() * 9000);
        let km = parseFloat(document.getElementById('kmInput').value) || 0;
        
        let booking = {
            id: bookingId,
            user: currentUser,
            vehicle: selectedVehicle,
            pickup: pickup,
            drop: drop,
            km: km,
            fare: finalFare,
            commission: Math.round(finalFare * 0.15),
            location: userLocation,
            time: new Date().toLocaleString()
        };
        
        try {
            await db.collection('bookings').add(booking);
            document.getElementById('successDetails').innerHTML = `
                <b>‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ID:</b> ${bookingId}<br>
                <b>‡§ó‡§æ‡§°‡§º‡•Ä:</b> ${selectedVehicle}<br>
                <b>‡§ï‡§ø‡§∞‡§æ‡§Ø‡§æ:</b> ‚Çπ${finalFare}<br>
                <b>‡§™‡§ø‡§ï‡§Ö‡§™:</b> ${pickup}<br>
                <b>‡§°‡•ç‡§∞‡•â‡§™:</b> ${drop}<br>
                <b>‡§¶‡•Ç‡§∞‡•Ä:</b> ${km} km<br>
                <small>‚è±Ô∏è ${new Date().toLocaleString()}</small>
            `;
            changeScreen('successScreen');
        } catch(e) {
            alert('Error: ' + e.message);
            console.error(e);
        }
    };

    // ---------- DRIVER REGISTRATION ----------
    window.registerDriver = async function() {
        let name = document.getElementById('driverName').value;
        let mobile = document.getElementById('driverMobile').value;
        let vehicleNum = document.getElementById('driverVehicleNum').value;
        let vehicleType = document.getElementById('driverVehicleType').value;
        let aadhaar = document.getElementById('driverAadhaar').value;

        if (!name || !mobile || !vehicleNum) {
            alert('‡§®‡§æ‡§Æ, ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§î‡§∞ ‡§ó‡§æ‡§°‡§º‡•Ä ‡§®‡§Ç‡§¨‡§∞ ‡§≠‡§∞‡•á‡§Ç');
            return;
        }
        if (mobile.length !== 10) {
            alert('‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ 10 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è');
            return;
        }
        
        try {
            await db.collection('drivers').add({
                name: name,
                mobile: mobile,
                vehicleNum: vehicleNum,
                vehicleType: vehicleType,
                aadhaar: aadhaar || "‡§®‡§π‡•Ä‡§Ç ‡§¶‡§ø‡§Ø‡§æ",
                status: 'pending',
                registeredAt: new Date().toISOString()
            });
            alert('‚úÖ ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•á‡§∂‡§® ‡§∏‡§´‡§≤! ‡§ú‡§≤‡•ç‡§¶ ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ‡•§');
            changeScreen('homeScreen');
            
            // ‡§´‡•â‡§∞‡•ç‡§Æ ‡§ñ‡§æ‡§≤‡•Ä ‡§ï‡§∞‡•ã
            document.getElementById('driverName').value = '';
            document.getElementById('driverMobile').value = '';
            document.getElementById('driverVehicleNum').value = '';
            document.getElementById('driverAadhaar').value = '';
        } catch(e) {
            alert('Error: ' + e.message);
            console.error(e);
        }
    };

    // ---------- HISTORY ----------
    window.showHistory = function() {
        changeScreen('historyScreen');
        loadHistory();
    };

    async function loadHistory() {
        let listDiv = document.getElementById('historyList');
        listDiv.innerHTML = '<p>‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</p>';
        
        if (!currentUser) {
            listDiv.innerHTML = '<p style="color:gray;">‡§™‡§π‡§≤‡•á ‡§ï‡•ã‡§à ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§ï‡§∞‡•á‡§Ç</p>';
            return;
        }
        
        try {
            const snapshot = await db.collection('bookings')
                .where('user', '==', currentUser)
                .orderBy('time', 'desc')
                .get();
                
            if (snapshot.empty) {
                listDiv.innerHTML = '<p style="color:gray;">‡§ï‡•ã‡§à ‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à</p>';
            } else {
                let html = '';
                snapshot.forEach(doc => {
                    let b = doc.data();
                    html += `<div style="background:white; padding:15px; border-radius:12px; margin-bottom:12px; border-left:4px solid #2854ff; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-weight:700;">${b.vehicle}</span>
                            <span style="background:#e8f0fe; padding:4px 8px; border-radius:20px; font-size:12px;">‚Çπ${b.fare}</span>
                        </div>
                        <p style="font-size:13px; color:gray; margin-top:8px;">üìç ${b.pickup || ''} ‚Üí ${b.drop || ''}</p>
                        <p style="font-size:11px; color:#999;">üìÖ ${b.time || ''}</p>
                    </div>`;
                });
                listDiv.innerHTML = html;
            }
        } catch(e) {
            console.error(e);
            listDiv.innerHTML = '<p style="color:red;">‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§ó‡§°‡§º‡§¨‡§°‡§º‡•Ä</p>';
        }
    }

    // ---------- ON LOAD ----------
    window.onload = function() {
        if (currentUser) {
            document.getElementById('currentLocText').innerHTML = 'üìç ' + currentUser;
        }
        // ‡§π‡•ã‡§Æ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§è‡§ï‡•ç‡§ü‡§ø‡§µ ‡§ï‡§∞‡•ã
        changeScreen('homeScreen');
        
        // ‡§°‡•ç‡§∞‡§æ‡§á‡§µ‡§∞ ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§Æ‡•á‡§Ç ‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä ‡§ï‡•á ‡§Ö‡§™‡•ç‡§∂‡§® ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•ã
        let select = document.getElementById('driverVehicleType');
        if (select) {
            select.innerHTML = `
                <option value="Tata Ace">Tata Ace</option>
                <option value="Pickup 8ft">Pickup 8ft</option>
                <option value="14ft Truck">14ft Truck</option>
                <option value="JCB">JCB</option>
                <option value="Crane">Crane</option>
                <option value="Tractor">Tractor</option>
            `;
        }
    };
</script>
