<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TruckEase Master Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { display: flex; background: #f0f2f5; height: 100vh; overflow: hidden; }
        
        /* sidebar */
        .sidebar { width: 280px; background: #1a1f2e; color: white; padding: 25px; overflow-y: auto; }
        .sidebar h2 { color: #3b82f6; margin-bottom: 40px; font-size: 22px; display: flex; align-items: center; gap: 8px; }
        .nav-item { padding: 12px 15px; display: flex; align-items: center; gap: 12px; color: #9ca3af; text-decoration: none; border-radius: 10px; margin-bottom: 8px; transition: 0.2s; cursor: pointer; }
        .nav-item i { font-size: 20px; }
        .nav-item.active, .nav-item:hover { background: #2d3349; color: white; }
        .sidebar-section { margin-top: 30px; font-size: 12px; color: #6b7280; letter-spacing: 1px; padding-left: 15px; }

        /* main */
        .main { flex: 1; padding: 25px; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { font-size: 24px; font-weight: 600; }
        .date-badge { background: white; padding: 10px 20px; border-radius: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); font-weight: 500; }

        /* cards */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .stat-card h4 { font-size: 13px; color: #64748b; margin-bottom: 8px; }
        .stat-card .value { font-size: 26px; font-weight: 700; color: #1e293b; }
        .stat-card .sub { font-size: 13px; color: #10b981; margin-top: 5px; }

        /* section tabs */
        .section-tabs { display: flex; gap: 15px; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
        .tab-btn { padding: 8px 16px; background: none; border: none; font-weight: 600; color: #64748b; cursor: pointer; border-radius: 20px; }
        .tab-btn.active { background: #3b82f6; color: white; }

        /* tables */
        .table-container { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.02); }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 14px 10px; color: #64748b; font-weight: 600; font-size: 13px; border-bottom: 2px solid #edf2f7; }
        td { padding: 14px 10px; border-bottom: 1px solid #edf2f7; font-size: 14px; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-block; }
        .status-pending { background: #fef3c7; color: #b45309; }
        .status-approved { background: #d1fae5; color: #065f46; }
        .status-rejected { background: #fee2e2; color: #b91c1c; }
        .status-completed { background: #dbeafe; color: #1e40af; }
        .btn-sm { padding: 6px 12px; border: none; border-radius: 8px; font-weight: 500; cursor: pointer; background: #3b82f6; color: white; margin-right: 5px; }
        .btn-sm.reject { background: #ef4444; }
        .doc-link { color: #3b82f6; text-decoration: underline; cursor: pointer; }

        /* loading */
        .loading { text-align: center; padding: 40px; color: #666; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>üì¶ TruckEase Admin</h2>
    <div class="nav-item active" data-view="dashboard">üìä Dashboard</div>
    <div class="nav-item" data-view="bookings">üìã Bookings</div>
    <div class="nav-item" data-view="drivers">üöõ Drivers</div>
    <div class="nav-item" data-view="customers">üë§ Customers</div>
    <div class="nav-item" data-view="earnings">üí∞ Earnings</div>
    <div class="sidebar-section">SETTINGS</div>
    <div class="nav-item" data-view="settings">‚öôÔ∏è Admin Profile</div>
</div>

<div class="main" id="mainContent">
    <!-- dynamic content will be injected by js -->
</div>

<!-- firebase sdk -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

<script>
    // ---------- FIREBASE INIT ----------
    const firebaseConfig = {
        apiKey: "AIzaSyByh4tT4zcUpjjQ_ebaYzpSulGtsDHjbw0",
        authDomain: "truckease-cb961.firebaseapp.com",
        projectId: "truckease-cb961",
        storageBucket: "truckease-cb961.firebasestorage.app",
        messagingSenderId: "558046020925",
        appId: "1:558046020925:web:573533af4bbf93841e3154"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    // ---------- SIMPLE ADMIN AUTH (placeholder) ----------
    // real app mein aap auth state check karenge aur sirf admin ko allow karenge
    auth.signInAnonymously().catch(console.error);

    // ---------- GLOBAL VARIABLES ----------
    let currentView = 'dashboard';
    let bookingsUnsubscribe = null;
    let driversUnsubscribe = null;

    // ---------- RENDER DIFFERENT VIEWS ----------
    function showView(view) {
        currentView = view;
        document.querySelectorAll('.nav-item').forEach(item => {
            if (item.dataset.view === view) item.classList.add('active');
            else item.classList.remove('active');
        });

        // clear previous listeners
        if (bookingsUnsubscribe) bookingsUnsubscribe();
        if (driversUnsubscribe) driversUnsubscribe();

        if (view === 'dashboard') renderDashboard();
        else if (view === 'bookings') renderBookings();
        else if (view === 'drivers') renderDrivers();
        else if (view === 'customers') renderCustomers();
        else if (view === 'earnings') renderEarnings();
        else if (view === 'settings') renderSettings();
    }

    // ---------- DASHBOARD VIEW ----------
    function renderDashboard() {
        const html = `
            <div class="header">
                <h1>üìä Global Dashboard</h1>
                <div class="date-badge">${new Date().toLocaleDateString('hi-IN')}</div>
            </div>
            <div class="stats-grid" id="dashboardStats">
                <div class="stat-card"><h4>Total Revenue</h4><div class="value" id="totalRevenue">‚Çπ0</div><div class="sub">‚Üë 12% from last month</div></div>
                <div class="stat-card"><h4>Commission Earned</h4><div class="value" id="totalCommission">‚Çπ0</div><div class="sub">15% avg</div></div>
                <div class="stat-card"><h4>Active Drivers</h4><div class="value" id="activeDrivers">0</div><div class="sub">${Math.floor(Math.random()*10)+5} pending approval</div></div>
                <div class="stat-card"><h4>Total Bookings</h4><div class="value" id="totalBookings">0</div><div class="sub">this month</div></div>
            </div>
            <div class="table-container">
                <h3>Recent Bookings</h3>
                <table>
                    <thead><tr><th>Vehicle</th><th>Pickup ‚Üí Drop</th><th>Fare</th><th>Status</th><th>Time</th></tr></thead>
                    <tbody id="recentBookingsBody"></tbody>
                </table>
            </div>
        `;
        document.getElementById('mainContent').innerHTML = html;
        loadDashboardStats();
    }

    async function loadDashboardStats() {
        // real-time listener for bookings
        bookingsUnsubscribe = db.collection('bookings').orderBy('timestamp', 'desc').limit(10).onSnapshot(snapshot => {
            let totalFare = 0, totalCommission = 0, bookingCount = 0;
            let rows = '';
            snapshot.forEach(doc => {
                const b = doc.data();
                totalFare += b.fare || 0;
                totalCommission += b.commission || 0;
                bookingCount++;
                const time = b.timestamp ? new Date(b.timestamp.toDate()).toLocaleString('hi-IN') : 'Just now';
                rows += `<tr>
                    <td>${b.vehicle || 'N/A'}</td>
                    <td>${(b.pickup || '').substring(0,15)}‚Ä¶ ‚Üí ${(b.drop || '').substring(0,15)}‚Ä¶</td>
                    <td>‚Çπ${b.fare}</td>
                    <td><span class="status-badge status-${b.status}">${b.status}</span></td>
                    <td>${time}</td>
                </tr>`;
            });
            document.getElementById('totalRevenue').innerText = '‚Çπ' + totalFare.toFixed(2);
            document.getElementById('totalCommission').innerText = '‚Çπ' + totalCommission.toFixed(2);
            document.getElementById('totalBookings').innerText = bookingCount;
            document.getElementById('recentBookingsBody').innerHTML = rows;
        });

        // count approved drivers
        driversUnsubscribe = db.collection('drivers').where('status', '==', 'approved').onSnapshot(snap => {
            document.getElementById('activeDrivers').innerText = snap.size;
        });
    }

    // ---------- BOOKINGS VIEW ----------
    function renderBookings() {
        const html = `
            <div class="header">
                <h1>üìã All Bookings</h1>
                <div class="date-badge">${new Date().toLocaleDateString('hi-IN')}</div>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Vehicle</th><th>User</th><th>Pickup ‚Üí Drop</th><th>Fare</th><th>Commission</th><th>Status</th><th>Driver</th></tr></thead>
                    <tbody id="bookingsBody"></tbody>
                </table>
            </div>
        `;
        document.getElementById('mainContent').innerHTML = html;
        loadAllBookings();
    }

    function loadAllBookings() {
        bookingsUnsubscribe = db.collection('bookings').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
            let rows = '';
            snapshot.forEach(doc => {
                const b = doc.data();
                rows += `<tr>
                    <td>${b.vehicle}</td>
                    <td>${b.userPhone || 'N/A'}</td>
                    <td>${(b.pickup || '').substring(0,12)}‚Ä¶ ‚Üí ${(b.drop || '').substring(0,12)}‚Ä¶</td>
                    <td>‚Çπ${b.fare}</td>
                    <td>‚Çπ${b.commission}</td>
                    <td><span class="status-badge status-${b.status}">${b.status}</span></td>
                    <td>${b.driverId ? b.driverId.substring(0,6) : 'Not assigned'}</td>
                </tr>`;
            });
            document.getElementById('bookingsBody').innerHTML = rows;
        });
    }

    // ---------- DRIVERS VIEW ----------
    function renderDrivers() {
        const html = `
            <div class="header">
                <h1>üöõ Driver Management</h1>
                <div class="section-tabs">
                    <button class="tab-btn active" onclick="filterDrivers('pending')">Pending</button>
                    <button class="tab-btn" onclick="filterDrivers('approved')">Approved</button>
                    <button class="tab-btn" onclick="filterDrivers('rejected')">Rejected</button>
                    <button class="tab-btn" onclick="filterDrivers('all')">All</button>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Name</th><th>Phone</th><th>Vehicle</th><th>Documents</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="driversBody"></tbody>
                </table>
            </div>
        `;
        document.getElementById('mainContent').innerHTML = html;
        loadDrivers('pending');
    }

    let currentDriverFilter = 'pending';
    function filterDrivers(status) {
        currentDriverFilter = status;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        loadDrivers(status);
    }

    function loadDrivers(status) {
        if (driversUnsubscribe) driversUnsubscribe();
        let query = db.collection('drivers');
        if (status !== 'all') query = query.where('status', '==', status);
        driversUnsubscribe = query.onSnapshot(snapshot => {
            let rows = '';
            snapshot.forEach(doc => {
                const d = doc.data();
                const docsList = d.documentUrls ? Object.keys(d.documentUrls).map(key => 
                    `<a href="${d.documentUrls[key]}" target="_blank" class="doc-link">üìé ${key}</a>`
                ).join(' ') : 'No docs';
                rows += `<tr>
                    <td>${d.personal?.fullName || d.name || 'N/A'}</td>
                    <td>${d.personal?.mobile || d.phone || 'N/A'}</td>
                    <td>${d.vehicle?.type || d.vehicleType || 'N/A'} (${d.vehicle?.number || d.vehicleNumber || ''})</td>
                    <td>${docsList}</td>
                    <td><span class="status-badge status-${d.status}">${d.status}</span></td>
                    <td>
                        ${d.status === 'pending_approval' ? `
                            <button class="btn-sm" onclick="approveDriver('${doc.id}')">‚úÖ Approve</button>
                            <button class="btn-sm reject" onclick="rejectDriver('${doc.id}')">‚ùå Reject</button>
                        ` : ''}
                        ${d.status === 'approved' ? `<button class="btn-sm reject" onclick="rejectDriver('${doc.id}')">‚õî Disable</button>` : ''}
                        ${d.status === 'rejected' ? `<button class="btn-sm" onclick="approveDriver('${doc.id}')">üîÑ Re-activate</button>` : ''}
                    </td>
                </tr>`;
            });
            document.getElementById('driversBody').innerHTML = rows || '<tr><td colspan="6" style="text-align:center">No drivers found</td></tr>';
        });
    }

    window.approveDriver = async (driverId) => {
        await db.collection('drivers').doc(driverId).update({ status: 'approved' });
        alert('Driver approved');
    };

    window.rejectDriver = async (driverId) => {
        await db.collection('drivers').doc(driverId).update({ status: 'rejected' });
        alert('Driver rejected');
    };

    // ---------- CUSTOMERS VIEW ----------
    function renderCustomers() {
        document.getElementById('mainContent').innerHTML = '<div class="header"><h1>üë§ Customers</h1></div><div class="table-container">Loading...</div>';
        // customers collection nahi hai, so we can show users from bookings or create separate collection
        // for demo, we'll show unique users from bookings
        db.collection('bookings').get().then(snapshot => {
            const users = new Map();
            snapshot.forEach(doc => {
                const b = doc.data();
                if (b.userPhone) users.set(b.userPhone, { phone: b.userPhone, lastBooking: b.timestamp, totalSpent: (users.get(b.userPhone)?.totalSpent || 0) + (b.fare || 0) });
            });
            let rows = '';
            users.forEach((u, phone) => {
                rows += `<tr><td>${phone}</td><td>${u.totalSpent}</td><td>${u.lastBooking ? new Date(u.lastBooking.toDate()).toLocaleDateString() : 'N/A'}</td></tr>`;
            });
            document.getElementById('mainContent').innerHTML = `
                <div class="header"><h1>üë§ Customers</h1></div>
                <div class="table-container">
                    <table><thead><tr><th>Phone</th><th>Total Spent</th><th>Last Booking</th></tr></thead>
                    <tbody>${rows || '<tr><td colspan="3">No data</td></tr>'}</tbody>
                </div>
            `;
        });
    }

    // ---------- EARNINGS VIEW ----------
    function renderEarnings() {
        document.getElementById('mainContent').innerHTML = '<div class="header"><h1>üí∞ Earnings</h1></div><div class="table-container">Coming soon...</div>';
    }

    // ---------- SETTINGS VIEW ----------
    function renderSettings() {
        document.getElementById('mainContent').innerHTML = '<div class="header"><h1>‚öôÔ∏è Admin Settings</h1></div><div class="table-container">Profile and preferences</div>';
    }

    // ---------- SIDEBAR CLICK HANDLING ----------
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => showView(item.dataset.view));
    });

    // start with dashboard
    showView('dashboard');
</script>
</body>
</html>
