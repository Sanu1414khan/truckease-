<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TruckEase USA - Freight on Demand</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Leaflet for map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: #f4f7fc; padding-bottom: 70px; }

        /* Premium Header with glass effect */
        .header { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 15px; display: flex; align-items: center; gap: 10px; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .location-bar { background: #eef2ff; padding: 12px 18px; border-radius: 40px; flex: 1; font-size: 14px; color: #2854ff; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; box-shadow: 0 2px 8px rgba(40,84,255,0.1); transition: all 0.2s; }
        .location-bar:hover { background: #e0e7ff; transform: scale(1.02); }
        .user-icon { font-size: 24px; color: #2854ff; background: white; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(40,84,255,0.15); border: 1px solid rgba(40,84,255,0.1); }

        /* Tabs with underline effect */
        .tabs { display: flex; gap: 20px; padding: 15px 20px; overflow-x: auto; background: white; border-bottom: 1px solid #f0f0f0; }
        .tab { padding: 8px 0; font-weight: 600; font-size: 16px; color: #999; white-space: nowrap; cursor: pointer; border-bottom: 3px solid transparent; transition: 0.2s; }
        .tab.active { color: #2854ff; border-bottom-color: #2854ff; }

        /* Vehicle Cards - Uber Freight style */
        .section-title { padding: 20px 20px 10px; font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .vehicle-grid { display: flex; flex-direction: column; gap: 12px; padding: 0 20px 20px; }
        .vehicle-card { background: white; border-radius: 24px; padding: 16px; display: flex; align-items: center; gap: 16px; box-shadow: 0 4px 16px rgba(0,0,0,0.02); border: 1px solid #f0f0f0; cursor: pointer; transition: 0.2s; }
        .vehicle-card:hover { border-color: #2854ff; box-shadow: 0 8px 24px rgba(40,84,255,0.1); transform: translateY(-2px); }
        .vehicle-card .icon { font-size: 48px; width: 60px; text-align: center; }
        .vehicle-info { flex: 1; }
        .vehicle-info h4 { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
        .vehicle-info p { font-size: 14px; color: #666; }
        .vehicle-price { text-align: right; }
        .vehicle-price .price { font-size: 20px; font-weight: 800; color: #2854ff; }
        .vehicle-price .eta { font-size: 13px; color: #10b981; margin-top: 4px; }

        /* Booking Screen */
        .screen { display: none; padding: 0; }
        .screen.active { display: block; }
        .booking-header { display: flex; align-items: center; gap: 20px; padding: 20px; background: white; border-bottom: 1px solid #f0f0f0; }
        .booking-header .back-btn { font-size: 24px; cursor: pointer; color: #2854ff; }
        .booking-header h3 { font-size: 20px; font-weight: 700; }
        .booking-content { padding: 20px; }

        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #444; }
        .input-group input { width: 100%; padding: 16px; border: 1px solid #e0e0e0; border-radius: 20px; font-size: 16px; transition: 0.2s; background: #fafafa; }
        .input-group input:focus { border-color: #2854ff; outline: none; background: white; box-shadow: 0 0 0 3px rgba(40,84,255,0.1); }

        .fare-box { background: linear-gradient(135deg, #eef2ff, #ffffff); padding: 20px; border-radius: 24px; text-align: center; margin: 20px 0; border: 1px solid rgba(40,84,255,0.2); }
        .fare-box .fare { font-size: 48px; font-weight: 800; color: #2854ff; line-height: 1.2; }
        .fare-box .breakdown { font-size: 14px; color: #666; margin-top: 8px; display: flex; justify-content: center; gap: 20px; }
        .btn { width: 100%; padding: 18px; border: none; border-radius: 30px; font-weight: 700; font-size: 18px; cursor: pointer; transition: 0.2s; margin-top: 10px; }
        .btn-primary { background: #2854ff; color: white; box-shadow: 0 10px 20px rgba(40,84,255,0.3); }
        .btn-primary:hover { background: #1a3ebb; transform: scale(1.02); }
        .btn-secondary { background: #e0e0e0; color: #333; }
        .btn-secondary:hover { background: #ccc; }

        #map { height: 240px; border-radius: 24px; margin: 20px 0; display: none; box-shadow: 0 8px 20px rgba(0,0,0,0.05); }

        /* History Items */
        .history-item { background: white; border-radius: 20px; padding: 16px; margin-bottom: 12px; border: 1px solid #f0f0f0; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .history-item .row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .status-badge { padding: 6px 14px; border-radius: 40px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-accepted { background: #cce5ff; color: #004085; }

        /* Login Modal - Premium */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 40px; width: 90%; max-width: 380px; text-align: center; box-shadow: 0 30px 60px rgba(0,0,0,0.3); }
        .modal-content h3 { font-size: 28px; font-weight: 800; margin-bottom: 20px; color: #2854ff; }
        .modal-content input { width: 100%; padding: 18px; margin: 10px 0; border: 1px solid #ddd; border-radius: 30px; font-size: 16px; }
        .demo-hint { background: #fef9e7; color: #b45f06; padding: 15px; border-radius: 20px; font-size: 14px; margin: 15px 0; border: 1px solid #f9e79f; }

        /* Bottom Navigation */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; max-width: 450px; background: white; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #eee; left: 50%; transform: translateX(-50%); z-index: 100; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); border-radius: 30px 30px 0 0; }
        .nav-item { text-align: center; color: #999; font-size: 12px; cursor: pointer; transition: 0.2s; }
        .nav-item.active { color: #2854ff; font-weight: 700; }
        .nav-item i { font-size: 24px; display: block; margin-bottom: 4px; }

        .loading { display: none; text-align: center; padding: 50px; }
        .loading.active { display: block; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #2854ff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- Login Modal - Demo Mode (USA) -->
<div id="loginModal" class="modal">
    <div class="modal-content">
        <h3>üîê Demo Login</h3>
        <div class="demo-hint">
            <i class="fas fa-info-circle"></i> Enter any 10-digit US number to continue
        </div>
        <div id="phoneSection">
            <input type="tel" id="phoneNumber" placeholder="e.g. 2125551234" maxlength="10" value="2125551234">
            <button class="btn btn-primary" id="demoLoginBtn" style="margin-top: 10px;">üöÄ Start Riding</button>
        </div>
        <p id="loginError" style="color:red; font-size:12px; margin-top:10px;"></p>
    </div>
</div>

<!-- Header (no language toggle) -->
<div class="header">
    <div class="location-bar" id="currentLocText" onclick="getCurrentLocation()">
        <i class="fas fa-map-marker-alt"></i> <span id="locationPlaceholder">Set pickup location</span>
    </div>
    <div class="user-icon" id="userIcon" onclick="showLoginModal()">
        <i class="fas fa-user"></i>
    </div>
</div>

<!-- Home Screen -->
<div id="homeScreen" class="screen active">
    <div class="tabs" id="tabContainer">
        <div class="tab active" data-category="trucks">üöö Trucks</div>
        <div class="tab" data-category="vans">üöê Vans</div>
        <div class="tab" data-category="special">‚öôÔ∏è Specialized</div>
    </div>
    <h3 class="section-title" id="vehicleCategoryTitle"><i class="fas fa-truck"></i> Available Trucks</h3>
    <div class="vehicle-grid" id="vehicleGrid"></div>
</div>

<!-- Booking Screen -->
<div id="bookingScreen" class="screen">
    <div class="booking-header">
        <i class="fas fa-arrow-left back-btn" onclick="goBack()"></i>
        <h3 id="bookingTitle">Confirm Your Shipment</h3>
    </div>
    <div class="booking-content">
        <div id="selectedVehicleInfo" style="margin-bottom:20px; font-weight:600; font-size:18px;"></div>
        <div class="input-group">
            <label>üìç Pickup</label>
            <input type="text" id="pickupAddr" placeholder="Enter pickup address" value="123 Main St, New York, NY">
        </div>
        <div class="input-group">
            <label>üèÅ Drop</label>
            <input type="text" id="dropAddr" placeholder="Enter drop address">
        </div>
        <div class="input-group">
            <label>üìè Distance (miles) or use GPS</label>
            <input type="number" id="kmInput" placeholder="Distance in miles" oninput="calculateFare()">
        </div>
        <div id="map"></div>
        <button class="btn btn-secondary" onclick="getCurrentLocation()"><i class="fas fa-location-dot"></i> Use my current location</button>

        <button class="btn btn-primary" onclick="calculateRoute()" style="margin-top:10px;">üõ£Ô∏è Get Route & Calculate Fare</button>

        <!-- Fare Breakdown Box -->
        <div class="fare-box">
            <div class="fare" id="fareAmount">$0</div>
            <div class="breakdown">
                <span id="baseFare">Base: $0</span>
                <span id="distanceFare">Distance: $0</span>
                <span id="totalFare">Total: $0</span>
            </div>
        </div>

        <button class="btn btn-primary" onclick="confirmBooking()">Confirm Booking</button>
    </div>
</div>

<!-- History Screen -->
<div id="historyScreen" class="screen">
    <div class="booking-header">
        <i class="fas fa-arrow-left back-btn" onclick="goBack()"></i>
        <h3>Your Trips</h3>
    </div>
    <div class="booking-content" id="historyList"></div>
</div>

<!-- Tracking Screen -->
<div id="trackingScreen" class="screen">
    <div class="booking-header">
        <i class="fas fa-arrow-left back-btn" onclick="goBack()"></i>
        <h3>Track Your Shipment</h3>
    </div>
    <div class="booking-content">
        <div id="trackingMap" style="height:300px; border-radius:24px; margin-bottom:20px;"></div>
        <div id="trackingDetails" style="background:#f0f4ff; padding:20px; border-radius:20px; margin-bottom:20px;">
            <p><i class="fas fa-circle-notch fa-spin"></i> Driver is on the way...</p>
        </div>
        <button class="btn btn-secondary" onclick="cancelBooking()">Cancel Trip</button>
    </div>
</div>

<!-- Success Screen -->
<div id="successScreen" class="screen">
    <div style="text-align:center; padding:50px 20px;">
        <i class="fas fa-check-circle" style="font-size:80px; color:#28a745;"></i>
        <h2 style="margin:20px 0;">Booking Confirmed!</h2>
        <div id="successDetails" style="background:#e8f5e9; padding:25px; border-radius:30px; margin:20px;"></div>
        <button class="btn btn-primary" onclick="goHome()">Back to Home</button>
    </div>
</div>

<!-- Bottom Navigation -->
<div class="bottom-nav">
    <div class="nav-item active" onclick="showScreen('homeScreen')"><i class="fas fa-home"></i><span>Home</span></div>
    <div class="nav-item" onclick="showScreen('historyScreen')"><i class="fas fa-history"></i><span>Trips</span></div>
    <div class="nav-item" onclick="alert('Coming soon')"><i class="fas fa-wallet"></i><span>Wallet</span></div>
    <div class="nav-item" onclick="alert('Coming soon')"><i class="fas fa-user"></i><span>Profile</span></div>
</div>

<!-- Loading -->
<div id="loading" class="loading"><div class="spinner"></div><p>Loading...</p></div>

<!-- Firebase SDK (only Firestore needed) -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script>
    // ---------- FIREBASE CONFIG ----------
    const firebaseConfig = {
        apiKey: "AIzaSyByh4tT4zcUpjjQ_ebaYzpSulGtsDHjbw0",
        authDomain: "truckease-cb961.firebaseapp.com",
        projectId: "truckease-cb961",
        storageBucket: "truckease-cb961.firebasestorage.app",
        messagingSenderId: "558046020925",
        appId: "1:558046020925:web:573533af4bbf93841e3154"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ---------- GLOBAL VARIABLES ----------
    let currentUser = null;
    let currentVehicle = null;
    let basePrice = 0, perKmRate = 0;
    let finalFare = 0;
    let map = null;
        // ---------- ROUTE CALCULATION (Leaflet Routing Machine) ----------
let routingControl = null;

// Geocode address to coordinates using Nominatim
async function geocodeAddress(address) {
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
    try {
        const res = await fetch(url);
        const data = await res.json();
        if (data && data.length > 0) {
            return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
        } else {
            throw new Error('Address not found');
        }
    } catch (e) {
        alert('Geocoding failed: ' + e.message);
        return null;
    }
}

// Main route calculation function
window.calculateRoute = async function() {
    const pickup = document.getElementById('pickupAddr').value;
    const drop = document.getElementById('dropAddr').value;
    
    if (!pickup || !drop) {
        alert('Please enter both pickup and drop addresses');
        return;
    }

    document.getElementById('loading').classList.add('active');

    const pickupCoords = await geocodeAddress(pickup);
    const dropCoords = await geocodeAddress(drop);

    if (!pickupCoords || !dropCoords) {
        document.getElementById('loading').classList.remove('active');
        return;
    }

    // Show map if not already visible
    const mapDiv = document.getElementById('map');
    mapDiv.style.display = 'block';

    // Initialize map if not exists
    if (!map) {
        map = L.map('map').setView([pickupCoords.lat, pickupCoords.lng], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    } else {
        map.setView([pickupCoords.lat, pickupCoords.lng], 10);
    }

    // Remove existing routing control
    if (routingControl) {
        map.removeControl(routingControl);
    }

    // Create new route
    routingControl = L.Routing.control({
        waypoints: [
            L.latLng(pickupCoords.lat, pickupCoords.lng),
            L.latLng(dropCoords.lat, dropCoords.lng)
        ],
        routeWhileDragging: false,
        showAlternatives: false,
        lineOptions: {
            styles: [{ color: '#2854ff', opacity: 0.8, weight: 6 }]
        },
        createMarker: function() { return null; } // no default markers
    }).addTo(map);

    // When route is found, update distance and fare
    routingControl.on('routesfound', function(e) {
        const routes = e.routes;
        const summary = routes[0].summary;
        // Distance in meters, convert to miles
        const distanceMiles = summary.totalDistance * 0.000621371;
        document.getElementById('kmInput').value = distanceMiles.toFixed(1);
        // Trigger fare calculation
        calculateFare();
        document.getElementById('loading').classList.remove('active');
    });

    routingControl.on('routingerror', function(e) {
        alert('Could not find route: ' + e.error.message);
        document.getElementById('loading').classList.remove('active');
    });
};

    // ---------- VEHICLE DATA (USA style) ----------
    const vehicleData = {
        trucks: [
            { icon: 'üöö', name: 'Box Truck 16ft', desc: 'Ideal for local deliveries', base: 65, perKm: 1.2, eta: 8 },
            { icon: 'üöõ', name: 'Semi-Truck 53ft', desc: 'Long-haul freight', base: 120, perKm: 2.0, eta: 15 },
            { icon: 'üöõ', name: 'Refrigerated Truck', desc: 'Temperature controlled', base: 150, perKm: 2.5, eta: 12 },
            { icon: 'üöú', name: 'Flatbed', desc: 'For heavy equipment', base: 140, perKm: 2.2, eta: 20 },
            { icon: 'üõª', name: 'Pickup Truck', desc: 'Small loads', base: 45, perKm: 0.9, eta: 5 }
        ],
        vans: [
            { icon: 'üöê', name: 'Cargo Van', desc: 'Perfect for parcels', base: 35, perKm: 0.7, eta: 4 },
            { icon: 'üöê', name: 'Sprinter Van', desc: 'Extra space', base: 50, perKm: 1.0, eta: 6 }
        ],
        special: [
            { icon: 'üèóÔ∏è', name: 'Crane Truck', desc: 'For heavy lifting', base: 200, perKm: 3.0, eta: 25 },
            { icon: 'üöõ', name: 'Hazmat Truck', desc: 'Certified for dangerous goods', base: 180, perKm: 2.8, eta: 18 }
        ]
    };

    // ---------- DEMO LOGIN ----------
    window.showLoginModal = function() {
        if (currentUser) {
            currentUser = null;
            document.getElementById('userIcon').innerHTML = `<i class="fas fa-user"></i>`;
            return;
        }
        document.getElementById('loginModal').classList.add('active');
    };

    document.getElementById('demoLoginBtn').addEventListener('click', function() {
        const phone = document.getElementById('phoneNumber').value;
        if (!phone || phone.length !== 10) {
            document.getElementById('loginError').innerText = 'Enter a 10-digit US number';
            return;
        }
        currentUser = { uid: 'demo_' + phone, phoneNumber: '+1' + phone };
        document.getElementById('userIcon').innerHTML = `<i class="fas fa-user-check"></i>`;
        document.getElementById('loginModal').classList.remove('active');
        document.getElementById('loginError').innerText = '';
    });

    // ---------- SCREEN MANAGEMENT ----------
    window.showScreen = function(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach((item, idx) => {
            if (screenId === 'homeScreen' && idx === 0) item.classList.add('active');
            else if (screenId === 'historyScreen' && idx === 1) item.classList.add('active');
            else item.classList.remove('active');
        });
        if (screenId === 'historyScreen') loadHistory();
        if (screenId === 'homeScreen') loadVehicleGrid('trucks');
    };

    window.goBack = () => showScreen('homeScreen');
    window.goHome = () => showScreen('homeScreen');

    // ---------- LOAD VEHICLE GRID ----------
    function loadVehicleGrid(category) {
        const grid = document.getElementById('vehicleGrid');
        const title = document.getElementById('vehicleCategoryTitle');
        if (category === 'trucks') title.innerHTML = '<i class="fas fa-truck"></i> Trucks';
        else if (category === 'vans') title.innerHTML = '<i class="fas fa-truck"></i> Vans';
        else title.innerHTML = '<i class="fas fa-truck"></i> Specialized';

        let html = '';
        vehicleData[category].forEach(v => {
            html += `<div class="vehicle-card" data-name="${v.name}" data-base="${v.base}" data-perkm="${v.perKm}" data-eta="${v.eta}">
                <div class="icon">${v.icon}</div>
                <div class="vehicle-info">
                    <h4>${v.name}</h4>
                    <p>${v.desc}</p>
                </div>
                <div class="vehicle-price">
                    <div class="price">$${v.base}</div>
                    <div class="eta">${v.eta} min away</div>
                </div>
            </div>`;
        });
        grid.innerHTML = html;

        document.querySelectorAll('.vehicle-card').forEach(card => {
            card.addEventListener('click', () => {
                currentVehicle = card.dataset.name;
                basePrice = parseFloat(card.dataset.base);
                perKmRate = parseFloat(card.dataset.perkm);
                document.getElementById('selectedVehicleInfo').innerHTML = `üöò ${currentVehicle}`;
                showScreen('bookingScreen');
                document.getElementById('kmInput').value = '';
                document.getElementById('fareAmount').innerText = '$0';
            });
        });
    }

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            loadVehicleGrid(this.dataset.category);
        });
    });

    // ---------- FARE CALCULATION ----------
    window.calculateFare = function() {
        let km = parseFloat(document.getElementById('kmInput').value) || 0;
        finalFare = basePrice + (km * perKmRate);
        document.getElementById('fareAmount').innerText = '$' + finalFare.toFixed(2);
        document.getElementById('baseFare').innerText = `Base: $${basePrice}`;
        document.getElementById('distanceFare').innerText = `Distance: $${(km * perKmRate).toFixed(2)}`;
        document.getElementById('totalFare').innerText = `Total: $${finalFare.toFixed(2)}`;
    };

    // ---------- GPS LOCATION (USA) ----------
    window.getCurrentLocation = function() {
        if (!navigator.geolocation) { alert('Geolocation not supported'); return; }
        document.getElementById('loading').classList.add('active');
        navigator.geolocation.getCurrentPosition(async pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            document.getElementById('map').style.display = 'block';
            if (map) map.remove();
            map = L.map('map').setView([lat, lng], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            L.marker([lat, lng]).addTo(map).bindPopup('You are here').openPopup();
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await res.json();
                document.getElementById('pickupAddr').value = data.display_name || 'Location found';
            } catch(e) { }
            document.getElementById('loading').classList.remove('active');
        }, err => {
            alert('Unable to get location');
            document.getElementById('loading').classList.remove('active');
        });
    };

    // ---------- CONFIRM BOOKING ----------
    window.confirmBooking = async function() {
        if (!currentUser) { alert('Please login first'); showLoginModal(); return; }
        if (finalFare <= 0) { alert('Enter distance'); return; }
        const pickup = document.getElementById('pickupAddr').value || 'Unknown';
        const drop = document.getElementById('dropAddr').value || 'Unknown';
        const km = parseFloat(document.getElementById('kmInput').value) || 0;

        const commission = Math.round(finalFare * 0.15 * 100) / 100;
        const driverAmount = finalFare - commission;

        const booking = {
            userId: currentUser.uid,
            userPhone: currentUser.phoneNumber,
            vehicle: currentVehicle,
            pickup, drop, km,
            fare: finalFare, commission, driverAmount,
            currency: '$',
            status: 'pending',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            document.getElementById('loading').classList.add('active');
            const docRef = await db.collection('bookings').add(booking);
            document.getElementById('loading').classList.remove('active');
            document.getElementById('successDetails').innerHTML = `
                <p><strong>Booking ID:</strong> ${docRef.id.slice(0,8)}</p>
                <p><strong>Vehicle:</strong> ${currentVehicle}</p>
                <p><strong>Fare:</strong> $${finalFare.toFixed(2)}</p>
                <p><strong>Pickup:</strong> ${pickup.substring(0,30)}...</p>
            `;
            showScreen('successScreen');
        } catch (e) {
            alert('Booking failed: ' + e.message);
            document.getElementById('loading').classList.remove('active');
        }
    };

    // ---------- LOAD HISTORY ----------
    window.loadHistory = async function() {
        if (!currentUser) { document.getElementById('historyList').innerHTML = '<p>Please login</p>'; return; }
        try {
            const snapshot = await db.collection('bookings')
                .where('userId', '==', currentUser.uid)
                .orderBy('timestamp', 'desc')
                .get();
            if (snapshot.empty) { document.getElementById('historyList').innerHTML = '<p>No trips yet</p>'; return; }
            let html = '';
            snapshot.forEach(doc => {
                const b = doc.data();
                const time = b.timestamp ? new Date(b.timestamp.toDate()).toLocaleString('en-US') : '';
                html += `<div class="history-item">
                    <div class="row"><span>${b.vehicle}</span><span class="status-badge status-${b.status}">${b.status}</span></div>
                    <div class="row"><small>${b.pickup.substring(0,20)} ‚Üí ${b.drop.substring(0,20)}</small></div>
                    <div class="row"><span>$${b.fare?.toFixed(2)}</span><small>${time}</small></div>
                </div>`;
            });
            document.getElementById('historyList').innerHTML = html;
        } catch(e) { document.getElementById('historyList').innerHTML = '<p>Error loading</p>'; }
    };

    window.cancelBooking = () => goHome();

    // Close modal on outside click
    document.getElementById('loginModal').addEventListener('click', function(e) {
        if (e.target === this) this.classList.remove('active');
    });

    // Initialize with trucks
    loadVehicleGrid('trucks');
</script>
</body>
</html>
